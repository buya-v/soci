function y(n,e,t,s,r){if(typeof e=="function"?n!==e||!0:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return e.set(n,t),t}function u(n,e,t,s){if(t==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?s:t==="a"?s.call(n):s?s.value:e.get(n)}let aa=function(){const{crypto:n}=globalThis;if(n!=null&&n.randomUUID)return aa=n.randomUUID.bind(n),n.randomUUID();const e=new Uint8Array(1),t=n?()=>n.getRandomValues(e)[0]:()=>Math.random()*255&255;return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,s=>(+s^t()&15>>+s/4).toString(16))};function vt(n){return typeof n=="object"&&n!==null&&("name"in n&&n.name==="AbortError"||"message"in n&&String(n.message).includes("FetchRequestCanceledException"))}const ln=n=>{if(n instanceof Error)return n;if(typeof n=="object"&&n!==null){try{if(Object.prototype.toString.call(n)==="[object Error]"){const e=new Error(n.message,n.cause?{cause:n.cause}:{});return n.stack&&(e.stack=n.stack),n.cause&&!e.cause&&(e.cause=n.cause),n.name&&(e.name=n.name),e}}catch{}try{return new Error(JSON.stringify(n))}catch{}}return new Error(n)};class P extends Error{}let re=class un extends P{constructor(e,t,s,r){super(`${un.makeMessage(e,t,s)}`),this.status=e,this.headers=r,this.requestID=r==null?void 0:r.get("request-id"),this.error=t}static makeMessage(e,t,s){const r=t!=null&&t.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):s;return e&&r?`${e} ${r}`:e?`${e} status code (no body)`:r||"(no status code or body)"}static generate(e,t,s,r){if(!e||!r)return new Es({message:s,cause:ln(t)});const a=t;return e===400?new oa(e,a,s,r):e===401?new ca(e,a,s,r):e===403?new la(e,a,s,r):e===404?new ua(e,a,s,r):e===409?new ha(e,a,s,r):e===422?new da(e,a,s,r):e===429?new fa(e,a,s,r):e>=500?new ma(e,a,s,r):new un(e,a,s,r)}},le=class extends re{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}},Es=class extends re{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}},ia=class extends Es{constructor({message:e}={}){super({message:e??"Request timed out."})}},oa=class extends re{},ca=class extends re{},la=class extends re{},ua=class extends re{},ha=class extends re{},da=class extends re{},fa=class extends re{},ma=class extends re{};const ko=/^[a-z][a-z0-9+.-]*:/i,$o=n=>ko.test(n);let hn=n=>(hn=Array.isArray,hn(n)),or=hn;function dn(n){return typeof n!="object"?{}:n??{}}function Ao(n){if(!n)return!0;for(const e in n)return!1;return!0}function Ro(n,e){return Object.prototype.hasOwnProperty.call(n,e)}const vo=(n,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new P(`${n} must be an integer`);if(e<0)throw new P(`${n} must be a positive integer`);return e},ga=n=>{try{return JSON.parse(n)}catch{return}},Po=n=>new Promise(e=>setTimeout(e,n)),qe="0.71.2",Eo=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u";function Io(){return typeof Deno<"u"&&Deno.build!=null?"deno":typeof EdgeRuntime<"u"?"edge":Object.prototype.toString.call(typeof globalThis.process<"u"?globalThis.process:0)==="[object process]"?"node":"unknown"}const Mo=()=>{var t;const n=Io();if(n==="deno")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":qe,"X-Stainless-OS":lr(Deno.build.os),"X-Stainless-Arch":cr(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:((t=Deno.version)==null?void 0:t.deno)??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":qe,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":globalThis.process.version};if(n==="node")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":qe,"X-Stainless-OS":lr(globalThis.process.platform??"unknown"),"X-Stainless-Arch":cr(globalThis.process.arch??"unknown"),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":globalThis.process.version??"unknown"};const e=Co();return e?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":qe,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${e.browser}`,"X-Stainless-Runtime-Version":e.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":qe,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function Co(){if(typeof navigator>"u"||!navigator)return null;const n=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:e,pattern:t}of n){const s=t.exec(navigator.userAgent);if(s){const r=s[1]||0,a=s[2]||0,i=s[3]||0;return{browser:e,version:`${r}.${a}.${i}`}}}return null}const cr=n=>n==="x32"?"x32":n==="x86_64"||n==="x64"?"x64":n==="arm"?"arm":n==="aarch64"||n==="arm64"?"arm64":n?`other:${n}`:"unknown",lr=n=>(n=n.toLowerCase(),n.includes("ios")?"iOS":n==="android"?"Android":n==="darwin"?"MacOS":n==="win32"?"Windows":n==="freebsd"?"FreeBSD":n==="openbsd"?"OpenBSD":n==="linux"?"Linux":n?`Other:${n}`:"Unknown");let ur;const Oo=()=>ur??(ur=Mo());function To(){if(typeof fetch<"u")return fetch;throw new Error("`fetch` is not defined as a global; Either pass `fetch` to the client, `new Anthropic({ fetch })` or polyfill the global, `globalThis.fetch = fetch`")}function pa(...n){const e=globalThis.ReadableStream;if(typeof e>"u")throw new Error("`ReadableStream` is not defined as a global; You will need to polyfill it, `globalThis.ReadableStream = ReadableStream`");return new e(...n)}function _a(n){let e=Symbol.asyncIterator in n?n[Symbol.asyncIterator]():n[Symbol.iterator]();return pa({start(){},async pull(t){const{done:s,value:r}=await e.next();s?t.close():t.enqueue(r)},async cancel(){var t;await((t=e.return)==null?void 0:t.call(e))}})}function Mn(n){if(n[Symbol.asyncIterator])return n;const e=n.getReader();return{async next(){try{const t=await e.read();return t!=null&&t.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){const t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}async function No(n){var s,r;if(n===null||typeof n!="object")return;if(n[Symbol.asyncIterator]){await((r=(s=n[Symbol.asyncIterator]()).return)==null?void 0:r.call(s));return}const e=n.getReader(),t=e.cancel();e.releaseLock(),await t}const Bo=({headers:n,body:e})=>({bodyHeaders:{"content-type":"application/json"},body:JSON.stringify(e)});function Lo(n){let e=0;for(const r of n)e+=r.length;const t=new Uint8Array(e);let s=0;for(const r of n)t.set(r,s),s+=r.length;return t}let hr;function Cn(n){let e;return(hr??(e=new globalThis.TextEncoder,hr=e.encode.bind(e)))(n)}let dr;function fr(n){let e;return(dr??(e=new globalThis.TextDecoder,dr=e.decode.bind(e)))(n)}var Z,ee;let It=class{constructor(){Z.set(this,void 0),ee.set(this,void 0),y(this,Z,new Uint8Array),y(this,ee,null)}decode(e){if(e==null)return[];const t=e instanceof ArrayBuffer?new Uint8Array(e):typeof e=="string"?Cn(e):e;y(this,Z,Lo([u(this,Z,"f"),t]));const s=[];let r;for(;(r=Fo(u(this,Z,"f"),u(this,ee,"f")))!=null;){if(r.carriage&&u(this,ee,"f")==null){y(this,ee,r.index);continue}if(u(this,ee,"f")!=null&&(r.index!==u(this,ee,"f")+1||r.carriage)){s.push(fr(u(this,Z,"f").subarray(0,u(this,ee,"f")-1))),y(this,Z,u(this,Z,"f").subarray(u(this,ee,"f"))),y(this,ee,null);continue}const a=u(this,ee,"f")!==null?r.preceding-1:r.preceding,i=fr(u(this,Z,"f").subarray(0,a));s.push(i),y(this,Z,u(this,Z,"f").subarray(r.index)),y(this,ee,null)}return s}flush(){return u(this,Z,"f").length?this.decode(`
`):[]}};Z=new WeakMap,ee=new WeakMap;It.NEWLINE_CHARS=new Set([`
`,"\r"]);It.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function Fo(n,e){for(let r=e??0;r<n.length;r++){if(n[r]===10)return{preceding:r,index:r+1,carriage:!1};if(n[r]===13)return{preceding:r,index:r+1,carriage:!0}}return null}function jo(n){for(let s=0;s<n.length-1;s++){if(n[s]===10&&n[s+1]===10||n[s]===13&&n[s+1]===13)return s+2;if(n[s]===13&&n[s+1]===10&&s+3<n.length&&n[s+2]===13&&n[s+3]===10)return s+4}return-1}const ps={off:0,error:200,warn:300,info:400,debug:500},mr=(n,e,t)=>{if(n){if(Ro(ps,n))return n;z(t).warn(`${e} was set to ${JSON.stringify(n)}, expected one of ${JSON.stringify(Object.keys(ps))}`)}};function dt(){}function Bt(n,e,t){return!e||ps[n]>ps[t]?dt:e[n].bind(e)}const qo={error:dt,warn:dt,info:dt,debug:dt};let gr=new WeakMap;function z(n){const e=n.logger,t=n.logLevel??"off";if(!e)return qo;const s=gr.get(e);if(s&&s[0]===t)return s[1];const r={error:Bt("error",e,t),warn:Bt("warn",e,t),info:Bt("info",e,t),debug:Bt("debug",e,t)};return gr.set(e,[t,r]),r}const Pe=n=>(n.options&&(n.options={...n.options},delete n.options.headers),n.headers&&(n.headers=Object.fromEntries((n.headers instanceof Headers?[...n.headers]:Object.entries(n.headers)).map(([e,t])=>[e,e.toLowerCase()==="x-api-key"||e.toLowerCase()==="authorization"||e.toLowerCase()==="cookie"||e.toLowerCase()==="set-cookie"?"***":t]))),"retryOfRequestLogID"in n&&(n.retryOfRequestLogID&&(n.retryOf=n.retryOfRequestLogID),delete n.retryOfRequestLogID),n);var Qe;let Pt=class ft{constructor(e,t,s){this.iterator=e,Qe.set(this,void 0),this.controller=t,y(this,Qe,s)}static fromSSEResponse(e,t,s){let r=!1;const a=s?z(s):console;async function*i(){if(r)throw new P("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let o=!1;try{for await(const c of Uo(e,t)){if(c.event==="completion")try{yield JSON.parse(c.data)}catch(h){throw a.error("Could not parse message into JSON:",c.data),a.error("From chunk:",c.raw),h}if(c.event==="message_start"||c.event==="message_delta"||c.event==="message_stop"||c.event==="content_block_start"||c.event==="content_block_delta"||c.event==="content_block_stop")try{yield JSON.parse(c.data)}catch(h){throw a.error("Could not parse message into JSON:",c.data),a.error("From chunk:",c.raw),h}if(c.event!=="ping"&&c.event==="error")throw new re(void 0,ga(c.data)??c.data,void 0,e.headers)}o=!0}catch(c){if(vt(c))return;throw c}finally{o||t.abort()}}return new ft(i,t,s)}static fromReadableStream(e,t,s){let r=!1;async function*a(){const o=new It,c=Mn(e);for await(const h of c)for(const m of o.decode(h))yield m;for(const h of o.flush())yield h}async function*i(){if(r)throw new P("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let o=!1;try{for await(const c of a())o||c&&(yield JSON.parse(c));o=!0}catch(c){if(vt(c))return;throw c}finally{o||t.abort()}}return new ft(i,t,s)}[(Qe=new WeakMap,Symbol.asyncIterator)](){return this.iterator()}tee(){const e=[],t=[],s=this.iterator(),r=a=>({next:()=>{if(a.length===0){const i=s.next();e.push(i),t.push(i)}return a.shift()}});return[new ft(()=>r(e),this.controller,u(this,Qe,"f")),new ft(()=>r(t),this.controller,u(this,Qe,"f"))]}toReadableStream(){const e=this;let t;return pa({async start(){t=e[Symbol.asyncIterator]()},async pull(s){try{const{value:r,done:a}=await t.next();if(a)return s.close();const i=Cn(JSON.stringify(r)+`
`);s.enqueue(i)}catch(r){s.error(r)}},async cancel(){var s;await((s=t.return)==null?void 0:s.call(t))}})}};async function*Uo(n,e){if(!n.body)throw e.abort(),typeof globalThis.navigator<"u"&&globalThis.navigator.product==="ReactNative"?new P("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api"):new P("Attempted to iterate over a response with no body");const t=new Do,s=new It,r=Mn(n.body);for await(const a of Wo(r))for(const i of s.decode(a)){const o=t.decode(i);o&&(yield o)}for(const a of s.flush()){const i=t.decode(a);i&&(yield i)}}async function*Wo(n){let e=new Uint8Array;for await(const t of n){if(t==null)continue;const s=t instanceof ArrayBuffer?new Uint8Array(t):typeof t=="string"?Cn(t):t;let r=new Uint8Array(e.length+s.length);r.set(e),r.set(s,e.length),e=r;let a;for(;(a=jo(e))!==-1;)yield e.slice(0,a),e=e.slice(a)}e.length>0&&(yield e)}let Do=class{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const a={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],a}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,s,r]=Ho(e,":");return r.startsWith(" ")&&(r=r.substring(1)),t==="event"?this.event=r:t==="data"&&this.data.push(r),null}};function Ho(n,e){const t=n.indexOf(e);return t!==-1?[n.substring(0,t),e,n.substring(t+e.length)]:[n,"",""]}async function ya(n,e){const{response:t,requestLogID:s,retryOfRequestLogID:r,startTime:a}=e,i=await(async()=>{var f;if(e.options.stream)return z(n).debug("response",t.status,t.url,t.headers,t.body),e.options.__streamClass?e.options.__streamClass.fromSSEResponse(t,e.controller):Pt.fromSSEResponse(t,e.controller);if(t.status===204)return null;if(e.options.__binaryResponse)return t;const o=t.headers.get("content-type"),c=(f=o==null?void 0:o.split(";")[0])==null?void 0:f.trim();if((c==null?void 0:c.includes("application/json"))||(c==null?void 0:c.endsWith("+json"))){const p=await t.json();return wa(p,t)}return await t.text()})();return z(n).debug(`[${s}] response parsed`,Pe({retryOfRequestLogID:r,url:t.url,status:t.status,body:i,durationMs:Date.now()-a})),i}function wa(n,e){return!n||typeof n!="object"||Array.isArray(n)?n:Object.defineProperty(n,"_request_id",{value:e.headers.get("request-id"),enumerable:!1})}var mt;let ba=class Sa extends Promise{constructor(e,t,s=ya){super(r=>{r(null)}),this.responsePromise=t,this.parseResponse=s,mt.set(this,void 0),y(this,mt,e)}_thenUnwrap(e){return new Sa(u(this,mt,"f"),this.responsePromise,async(t,s)=>wa(e(await this.parseResponse(t,s),s),s.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(e=>this.parseResponse(u(this,mt,"f"),e))),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}};mt=new WeakMap;var Lt;let xa=class{constructor(e,t,s,r){Lt.set(this,void 0),y(this,Lt,e),this.options=r,this.response=t,this.body=s}hasNextPage(){return this.getPaginatedItems().length?this.nextPageRequestOptions()!=null:!1}async getNextPage(){const e=this.nextPageRequestOptions();if(!e)throw new P("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");return await u(this,Lt,"f").requestAPIList(this.constructor,e)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(Lt=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const t of e.getPaginatedItems())yield t}},Jo=class extends ba{constructor(e,t,s){super(e,t,async(r,a)=>new s(r,a.response,await ya(r,a),a.options))}async*[Symbol.asyncIterator](){const e=await this;for await(const t of e)yield t}},Mt=class extends xa{constructor(e,t,s,r){super(e,t,s,r),this.data=s.data||[],this.has_more=s.has_more||!1,this.first_id=s.first_id||null,this.last_id=s.last_id||null}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageRequestOptions(){var t;if((t=this.options.query)!=null&&t.before_id){const s=this.first_id;return s?{...this.options,query:{...dn(this.options.query),before_id:s}}:null}const e=this.last_id;return e?{...this.options,query:{...dn(this.options.query),after_id:e}}:null}};class ka extends xa{constructor(e,t,s,r){super(e,t,s,r),this.data=s.data||[],this.has_more=s.has_more||!1,this.next_page=s.next_page||null}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageRequestOptions(){const e=this.next_page;return e?{...this.options,query:{...dn(this.options.query),page:e}}:null}}const $a=()=>{var n;if(typeof File>"u"){const{process:e}=globalThis,t=typeof((n=e==null?void 0:e.versions)==null?void 0:n.node)=="string"&&parseInt(e.versions.node.split("."))<20;throw new Error("`File` is not defined as a global, which is required for file uploads."+(t?" Update to Node 20 LTS or newer, or set `globalThis.File` to `import('node:buffer').File`.":""))}};function Xe(n,e,t){return $a(),new File(n,e??"unknown_file",t)}function as(n){return(typeof n=="object"&&n!==null&&("name"in n&&n.name&&String(n.name)||"url"in n&&n.url&&String(n.url)||"filename"in n&&n.filename&&String(n.filename)||"path"in n&&n.path&&String(n.path))||"").split(/[\\/]/).pop()||void 0}const Aa=n=>n!=null&&typeof n=="object"&&typeof n[Symbol.asyncIterator]=="function",On=async(n,e)=>({...n,body:await Ko(n.body,e)}),pr=new WeakMap;function Xo(n){const e=typeof n=="function"?n:n.fetch,t=pr.get(e);if(t)return t;const s=(async()=>{try{const r="Response"in e?e.Response:(await e("data:,")).constructor,a=new FormData;return a.toString()!==await new r(a).text()}catch{return!0}})();return pr.set(e,s),s}const Ko=async(n,e)=>{if(!await Xo(e))throw new TypeError("The provided fetch function does not support file uploads with the current global FormData class.");const t=new FormData;return await Promise.all(Object.entries(n||{}).map(([s,r])=>fn(t,s,r))),t},Vo=n=>n instanceof Blob&&"name"in n,fn=async(n,e,t)=>{if(t!==void 0){if(t==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")n.append(e,String(t));else if(t instanceof Response){let s={};const r=t.headers.get("Content-Type");r&&(s={type:r}),n.append(e,Xe([await t.blob()],as(t),s))}else if(Aa(t))n.append(e,Xe([await new Response(_a(t)).blob()],as(t)));else if(Vo(t))n.append(e,Xe([t],as(t),{type:t.type}));else if(Array.isArray(t))await Promise.all(t.map(s=>fn(n,e+"[]",s)));else if(typeof t=="object")await Promise.all(Object.entries(t).map(([s,r])=>fn(n,`${e}[${s}]`,r)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${t} instead`)}},Ra=n=>n!=null&&typeof n=="object"&&typeof n.size=="number"&&typeof n.type=="string"&&typeof n.text=="function"&&typeof n.slice=="function"&&typeof n.arrayBuffer=="function",zo=n=>n!=null&&typeof n=="object"&&typeof n.name=="string"&&typeof n.lastModified=="number"&&Ra(n),Qo=n=>n!=null&&typeof n=="object"&&typeof n.url=="string"&&typeof n.blob=="function";async function Go(n,e,t){if($a(),n=await n,e||(e=as(n)),zo(n))return n instanceof File&&e==null&&t==null?n:Xe([await n.arrayBuffer()],e??n.name,{type:n.type,lastModified:n.lastModified,...t});if(Qo(n)){const r=await n.blob();return e||(e=new URL(n.url).pathname.split(/[\\/]/).pop()),Xe(await mn(r),e,t)}const s=await mn(n);if(!(t!=null&&t.type)){const r=s.find(a=>typeof a=="object"&&"type"in a&&a.type);typeof r=="string"&&(t={...t,type:r})}return Xe(s,e,t)}async function mn(n){var t;let e=[];if(typeof n=="string"||ArrayBuffer.isView(n)||n instanceof ArrayBuffer)e.push(n);else if(Ra(n))e.push(n instanceof Blob?n:await n.arrayBuffer());else if(Aa(n))for await(const s of n)e.push(...await mn(s));else{const s=(t=n==null?void 0:n.constructor)==null?void 0:t.name;throw new Error(`Unexpected data type: ${typeof n}${s?`; constructor: ${s}`:""}${Yo(n)}`)}return e}function Yo(n){return typeof n!="object"||n===null?"":`; props: [${Object.getOwnPropertyNames(n).map(t=>`"${t}"`).join(", ")}]`}let ue=class{constructor(e){this._client=e}};const va=Symbol.for("brand.privateNullableHeaders");function*Zo(n){if(!n)return;if(va in n){const{values:s,nulls:r}=n;yield*s.entries();for(const a of r)yield[a,null];return}let e=!1,t;n instanceof Headers?t=n.entries():or(n)?t=n:(e=!0,t=Object.entries(n??{}));for(let s of t){const r=s[0];if(typeof r!="string")throw new TypeError("expected header name to be a string");const a=or(s[1])?s[1]:[s[1]];let i=!1;for(const o of a)o!==void 0&&(e&&!i&&(i=!0,yield[r,null]),yield[r,o])}}const M=n=>{const e=new Headers,t=new Set;for(const s of n){const r=new Set;for(const[a,i]of Zo(s)){const o=a.toLowerCase();r.has(o)||(e.delete(a),r.add(o)),i===null?(e.delete(a),t.add(o)):(e.append(a,i),t.delete(o))}}return{[va]:!0,values:e,nulls:t}};function Pa(n){return n.replace(/[^A-Za-z0-9\-._~!$&'()*+,;=:@]+/g,encodeURIComponent)}const _r=Object.freeze(Object.create(null)),ec=(n=Pa)=>function(t,...s){if(t.length===1)return t[0];let r=!1;const a=[],i=t.reduce((m,f,p)=>{var b;/[?#]/.test(f)&&(r=!0);const d=s[p];let _=(r?encodeURIComponent:n)(""+d);return p!==s.length&&(d==null||typeof d=="object"&&d.toString===((b=Object.getPrototypeOf(Object.getPrototypeOf(d.hasOwnProperty??_r)??_r))==null?void 0:b.toString))&&(_=d+"",a.push({start:m.length+f.length,length:_.length,error:`Value of type ${Object.prototype.toString.call(d).slice(8,-1)} is not a valid path parameter`})),m+f+(p===s.length?"":_)},""),o=i.split(/[?#]/,1)[0],c=new RegExp("(?<=^|\\/)(?:\\.|%2e){1,2}(?=\\/|$)","gi");let h;for(;(h=c.exec(o))!==null;)a.push({start:h.index,length:h[0].length,error:`Value "${h[0]}" can't be safely passed as a path parameter`});if(a.sort((m,f)=>m.start-f.start),a.length>0){let m=0;const f=a.reduce((p,d)=>{const _=" ".repeat(d.start-m),b="^".repeat(d.length);return m=d.start+d.length,p+_+b},"");throw new P(`Path parameters result in path with invalid segments:
${a.map(p=>p.error).join(`
`)}
${i}
${f}`)}return i},X=ec(Pa);let Ea=class extends ue{list(e={},t){const{betas:s,...r}=e??{};return this._client.getAPIList("/v1/files",Mt,{query:r,...t,headers:M([{"anthropic-beta":[...s??[],"files-api-2025-04-14"].toString()},t==null?void 0:t.headers])})}delete(e,t={},s){const{betas:r}=t??{};return this._client.delete(X`/v1/files/${e}`,{...s,headers:M([{"anthropic-beta":[...r??[],"files-api-2025-04-14"].toString()},s==null?void 0:s.headers])})}download(e,t={},s){const{betas:r}=t??{};return this._client.get(X`/v1/files/${e}/content`,{...s,headers:M([{"anthropic-beta":[...r??[],"files-api-2025-04-14"].toString(),Accept:"application/binary"},s==null?void 0:s.headers]),__binaryResponse:!0})}retrieveMetadata(e,t={},s){const{betas:r}=t??{};return this._client.get(X`/v1/files/${e}`,{...s,headers:M([{"anthropic-beta":[...r??[],"files-api-2025-04-14"].toString()},s==null?void 0:s.headers])})}upload(e,t){const{betas:s,...r}=e;return this._client.post("/v1/files",On({body:r,...t,headers:M([{"anthropic-beta":[...s??[],"files-api-2025-04-14"].toString()},t==null?void 0:t.headers])},this._client))}},Ia=class extends ue{retrieve(e,t={},s){const{betas:r}=t??{};return this._client.get(X`/v1/models/${e}?beta=true`,{...s,headers:M([{...(r==null?void 0:r.toString())!=null?{"anthropic-beta":r==null?void 0:r.toString()}:void 0},s==null?void 0:s.headers])})}list(e={},t){const{betas:s,...r}=e??{};return this._client.getAPIList("/v1/models?beta=true",Mt,{query:r,...t,headers:M([{...(s==null?void 0:s.toString())!=null?{"anthropic-beta":s==null?void 0:s.toString()}:void 0},t==null?void 0:t.headers])})}};const Ma={"claude-opus-4-20250514":8192,"claude-opus-4-0":8192,"claude-4-opus-20250514":8192,"anthropic.claude-opus-4-20250514-v1:0":8192,"claude-opus-4@20250514":8192,"claude-opus-4-1-20250805":8192,"anthropic.claude-opus-4-1-20250805-v1:0":8192,"claude-opus-4-1@20250805":8192};function yr(n,e,t){return!e||!("parse"in(e.output_format??{}))?{...n,content:n.content.map(s=>{if(s.type==="text"){const r=Object.defineProperty({...s},"parsed_output",{value:null,enumerable:!1});return Object.defineProperty(r,"parsed",{get(){return t.logger.warn("The `parsed` property on `text` blocks is deprecated, please use `parsed_output` instead."),null},enumerable:!1})}return s}),parsed_output:null}:Ca(n,e,t)}function Ca(n,e,t){let s=null;const r=n.content.map(a=>{if(a.type==="text"){const i=tc(e,a.text);s===null&&(s=i);const o=Object.defineProperty({...a},"parsed_output",{value:i,enumerable:!1});return Object.defineProperty(o,"parsed",{get(){return t.logger.warn("The `parsed` property on `text` blocks is deprecated, please use `parsed_output` instead."),i},enumerable:!1})}return a});return{...n,content:r,parsed_output:s}}function tc(n,e){var t;if(((t=n.output_format)==null?void 0:t.type)!=="json_schema")return null;try{return"parse"in n.output_format?n.output_format.parse(e):JSON.parse(e)}catch(s){throw new P(`Failed to parse structured output: ${s}`)}}const sc=n=>{let e=0,t=[];for(;e<n.length;){let s=n[e];if(s==="\\"){e++;continue}if(s==="{"){t.push({type:"brace",value:"{"}),e++;continue}if(s==="}"){t.push({type:"brace",value:"}"}),e++;continue}if(s==="["){t.push({type:"paren",value:"["}),e++;continue}if(s==="]"){t.push({type:"paren",value:"]"}),e++;continue}if(s===":"){t.push({type:"separator",value:":"}),e++;continue}if(s===","){t.push({type:"delimiter",value:","}),e++;continue}if(s==='"'){let o="",c=!1;for(s=n[++e];s!=='"';){if(e===n.length){c=!0;break}if(s==="\\"){if(e++,e===n.length){c=!0;break}o+=s+n[e],s=n[++e]}else o+=s,s=n[++e]}s=n[++e],c||t.push({type:"string",value:o});continue}if(s&&/\s/.test(s)){e++;continue}let a=/[0-9]/;if(s&&a.test(s)||s==="-"||s==="."){let o="";for(s==="-"&&(o+=s,s=n[++e]);s&&a.test(s)||s===".";)o+=s,s=n[++e];t.push({type:"number",value:o});continue}let i=/[a-z]/i;if(s&&i.test(s)){let o="";for(;s&&i.test(s)&&e!==n.length;)o+=s,s=n[++e];if(o=="true"||o=="false"||o==="null")t.push({type:"name",value:o});else{e++;continue}continue}e++}return t},Ue=n=>{if(n.length===0)return n;let e=n[n.length-1];switch(e.type){case"separator":return n=n.slice(0,n.length-1),Ue(n);case"number":let t=e.value[e.value.length-1];if(t==="."||t==="-")return n=n.slice(0,n.length-1),Ue(n);case"string":let s=n[n.length-2];if((s==null?void 0:s.type)==="delimiter")return n=n.slice(0,n.length-1),Ue(n);if((s==null?void 0:s.type)==="brace"&&s.value==="{")return n=n.slice(0,n.length-1),Ue(n);break;case"delimiter":return n=n.slice(0,n.length-1),Ue(n)}return n},nc=n=>{let e=[];return n.map(t=>{t.type==="brace"&&(t.value==="{"?e.push("}"):e.splice(e.lastIndexOf("}"),1)),t.type==="paren"&&(t.value==="["?e.push("]"):e.splice(e.lastIndexOf("]"),1))}),e.length>0&&e.reverse().map(t=>{t==="}"?n.push({type:"brace",value:"}"}):t==="]"&&n.push({type:"paren",value:"]"})}),n},rc=n=>{let e="";return n.map(t=>{switch(t.type){case"string":e+='"'+t.value+'"';break;default:e+=t.value;break}}),e},Oa=n=>JSON.parse(rc(nc(Ue(sc(n)))));var ae,we,Ne,Ge,Ft,Ye,Ze,jt,et,me,tt,qt,Ut,Ae,Wt,Dt,st,Ds,wr,Ht,Hs,Js,Xs,br;const Sr="__json_buf";function xr(n){return n.type==="tool_use"||n.type==="server_tool_use"||n.type==="mcp_tool_use"}class _s{constructor(e,t){ae.add(this),this.messages=[],this.receivedMessages=[],we.set(this,void 0),Ne.set(this,null),this.controller=new AbortController,Ge.set(this,void 0),Ft.set(this,()=>{}),Ye.set(this,()=>{}),Ze.set(this,void 0),jt.set(this,()=>{}),et.set(this,()=>{}),me.set(this,{}),tt.set(this,!1),qt.set(this,!1),Ut.set(this,!1),Ae.set(this,!1),Wt.set(this,void 0),Dt.set(this,void 0),st.set(this,void 0),Ht.set(this,s=>{if(y(this,qt,!0),vt(s)&&(s=new le),s instanceof le)return y(this,Ut,!0),this._emit("abort",s);if(s instanceof P)return this._emit("error",s);if(s instanceof Error){const r=new P(s.message);return r.cause=s,this._emit("error",r)}return this._emit("error",new P(String(s)))}),y(this,Ge,new Promise((s,r)=>{y(this,Ft,s,"f"),y(this,Ye,r,"f")})),y(this,Ze,new Promise((s,r)=>{y(this,jt,s,"f"),y(this,et,r,"f")})),u(this,Ge,"f").catch(()=>{}),u(this,Ze,"f").catch(()=>{}),y(this,Ne,e),y(this,st,(t==null?void 0:t.logger)??console)}get response(){return u(this,Wt,"f")}get request_id(){return u(this,Dt,"f")}async withResponse(){y(this,Ae,!0);const e=await u(this,Ge,"f");if(!e)throw new Error("Could not resolve a `Response` object");return{data:this,response:e,request_id:e.headers.get("request-id")}}static fromReadableStream(e){const t=new _s(null);return t._run(()=>t._fromReadableStream(e)),t}static createMessage(e,t,s,{logger:r}={}){const a=new _s(t,{logger:r});for(const i of t.messages)a._addMessageParam(i);return y(a,Ne,{...t,stream:!0}),a._run(()=>a._createMessage(e,{...t,stream:!0},{...s,headers:{...s==null?void 0:s.headers,"X-Stainless-Helper-Method":"stream"}})),a}_run(e){e().then(()=>{this._emitFinal(),this._emit("end")},u(this,Ht,"f"))}_addMessageParam(e){this.messages.push(e)}_addMessage(e,t=!0){this.receivedMessages.push(e),t&&this._emit("message",e)}async _createMessage(e,t,s){var i;const r=s==null?void 0:s.signal;let a;r&&(r.aborted&&this.controller.abort(),a=this.controller.abort.bind(this.controller),r.addEventListener("abort",a));try{u(this,ae,"m",Hs).call(this);const{response:o,data:c}=await e.create({...t,stream:!0},{...s,signal:this.controller.signal}).withResponse();this._connected(o);for await(const h of c)u(this,ae,"m",Js).call(this,h);if((i=c.controller.signal)!=null&&i.aborted)throw new le;u(this,ae,"m",Xs).call(this)}finally{r&&a&&r.removeEventListener("abort",a)}}_connected(e){this.ended||(y(this,Wt,e),y(this,Dt,e==null?void 0:e.headers.get("request-id")),u(this,Ft,"f").call(this,e),this._emit("connect"))}get ended(){return u(this,tt,"f")}get errored(){return u(this,qt,"f")}get aborted(){return u(this,Ut,"f")}abort(){this.controller.abort()}on(e,t){return(u(this,me,"f")[e]||(u(this,me,"f")[e]=[])).push({listener:t}),this}off(e,t){const s=u(this,me,"f")[e];if(!s)return this;const r=s.findIndex(a=>a.listener===t);return r>=0&&s.splice(r,1),this}once(e,t){return(u(this,me,"f")[e]||(u(this,me,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,s)=>{y(this,Ae,!0),e!=="error"&&this.once("error",s),this.once(e,t)})}async done(){y(this,Ae,!0),await u(this,Ze,"f")}get currentMessage(){return u(this,we,"f")}async finalMessage(){return await this.done(),u(this,ae,"m",Ds).call(this)}async finalText(){return await this.done(),u(this,ae,"m",wr).call(this)}_emit(e,...t){if(u(this,tt,"f"))return;e==="end"&&(y(this,tt,!0),u(this,jt,"f").call(this));const s=u(this,me,"f")[e];if(s&&(u(this,me,"f")[e]=s.filter(r=>!r.once),s.forEach(({listener:r})=>r(...t))),e==="abort"){const r=t[0];!u(this,Ae,"f")&&!(s!=null&&s.length)&&Promise.reject(r),u(this,Ye,"f").call(this,r),u(this,et,"f").call(this,r),this._emit("end");return}if(e==="error"){const r=t[0];!u(this,Ae,"f")&&!(s!=null&&s.length)&&Promise.reject(r),u(this,Ye,"f").call(this,r),u(this,et,"f").call(this,r),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalMessage",u(this,ae,"m",Ds).call(this))}async _fromReadableStream(e,t){var a;const s=t==null?void 0:t.signal;let r;s&&(s.aborted&&this.controller.abort(),r=this.controller.abort.bind(this.controller),s.addEventListener("abort",r));try{u(this,ae,"m",Hs).call(this),this._connected(null);const i=Pt.fromReadableStream(e,this.controller);for await(const o of i)u(this,ae,"m",Js).call(this,o);if((a=i.controller.signal)!=null&&a.aborted)throw new le;u(this,ae,"m",Xs).call(this)}finally{s&&r&&s.removeEventListener("abort",r)}}[(we=new WeakMap,Ne=new WeakMap,Ge=new WeakMap,Ft=new WeakMap,Ye=new WeakMap,Ze=new WeakMap,jt=new WeakMap,et=new WeakMap,me=new WeakMap,tt=new WeakMap,qt=new WeakMap,Ut=new WeakMap,Ae=new WeakMap,Wt=new WeakMap,Dt=new WeakMap,st=new WeakMap,Ht=new WeakMap,ae=new WeakSet,Ds=function(){if(this.receivedMessages.length===0)throw new P("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},wr=function(){if(this.receivedMessages.length===0)throw new P("stream ended without producing a Message with role=assistant");const t=this.receivedMessages.at(-1).content.filter(s=>s.type==="text").map(s=>s.text);if(t.length===0)throw new P("stream ended without producing a content block with type=text");return t.join(" ")},Hs=function(){this.ended||y(this,we,void 0)},Js=function(t){if(this.ended)return;const s=u(this,ae,"m",br).call(this,t);switch(this._emit("streamEvent",t,s),t.type){case"content_block_delta":{const r=s.content.at(-1);switch(t.delta.type){case"text_delta":{r.type==="text"&&this._emit("text",t.delta.text,r.text||"");break}case"citations_delta":{r.type==="text"&&this._emit("citation",t.delta.citation,r.citations??[]);break}case"input_json_delta":{xr(r)&&r.input&&this._emit("inputJson",t.delta.partial_json,r.input);break}case"thinking_delta":{r.type==="thinking"&&this._emit("thinking",t.delta.thinking,r.thinking);break}case"signature_delta":{r.type==="thinking"&&this._emit("signature",r.signature);break}default:t.delta}break}case"message_stop":{this._addMessageParam(s),this._addMessage(yr(s,u(this,Ne,"f"),{logger:u(this,st,"f")}),!0);break}case"content_block_stop":{this._emit("contentBlock",s.content.at(-1));break}case"message_start":{y(this,we,s);break}}},Xs=function(){if(this.ended)throw new P("stream has ended, this shouldn't happen");const t=u(this,we,"f");if(!t)throw new P("request ended without sending any chunks");return y(this,we,void 0),yr(t,u(this,Ne,"f"),{logger:u(this,st,"f")})},br=function(t){let s=u(this,we,"f");if(t.type==="message_start"){if(s)throw new P(`Unexpected event order, got ${t.type} before receiving "message_stop"`);return t.message}if(!s)throw new P(`Unexpected event order, got ${t.type} before "message_start"`);switch(t.type){case"message_stop":return s;case"message_delta":return s.container=t.delta.container,s.stop_reason=t.delta.stop_reason,s.stop_sequence=t.delta.stop_sequence,s.usage.output_tokens=t.usage.output_tokens,s.context_management=t.context_management,t.usage.input_tokens!=null&&(s.usage.input_tokens=t.usage.input_tokens),t.usage.cache_creation_input_tokens!=null&&(s.usage.cache_creation_input_tokens=t.usage.cache_creation_input_tokens),t.usage.cache_read_input_tokens!=null&&(s.usage.cache_read_input_tokens=t.usage.cache_read_input_tokens),t.usage.server_tool_use!=null&&(s.usage.server_tool_use=t.usage.server_tool_use),s;case"content_block_start":return s.content.push(t.content_block),s;case"content_block_delta":{const r=s.content.at(t.index);switch(t.delta.type){case"text_delta":{(r==null?void 0:r.type)==="text"&&(s.content[t.index]={...r,text:(r.text||"")+t.delta.text});break}case"citations_delta":{(r==null?void 0:r.type)==="text"&&(s.content[t.index]={...r,citations:[...r.citations??[],t.delta.citation]});break}case"input_json_delta":{if(r&&xr(r)){let a=r[Sr]||"";a+=t.delta.partial_json;const i={...r};if(Object.defineProperty(i,Sr,{value:a,enumerable:!1,writable:!0}),a)try{i.input=Oa(a)}catch(o){const c=new P(`Unable to parse tool parameter JSON from model. Please retry your request or adjust your prompt. Error: ${o}. JSON: ${a}`);u(this,Ht,"f").call(this,c)}s.content[t.index]=i}break}case"thinking_delta":{(r==null?void 0:r.type)==="thinking"&&(s.content[t.index]={...r,thinking:r.thinking+t.delta.thinking});break}case"signature_delta":{(r==null?void 0:r.type)==="thinking"&&(s.content[t.index]={...r,signature:t.delta.signature});break}default:t.delta}return s}case"content_block_stop":return s}},Symbol.asyncIterator)](){const e=[],t=[];let s=!1;return this.on("streamEvent",r=>{const a=t.shift();a?a.resolve(r):e.push(r)}),this.on("end",()=>{s=!0;for(const r of t)r.resolve(void 0);t.length=0}),this.on("abort",r=>{s=!0;for(const a of t)a.reject(r);t.length=0}),this.on("error",r=>{s=!0;for(const a of t)a.reject(r);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:s?{value:void 0,done:!0}:new Promise((a,i)=>t.push({resolve:a,reject:i})).then(a=>a?{value:a,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new Pt(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}const ac=1e5,ic=`You have been working on the task described above but have not yet completed it. Write a continuation summary that will allow you (or another instance of yourself) to resume work efficiently in a future context window where the conversation history will be replaced with this summary. Your summary should be structured, concise, and actionable. Include:
1. Task Overview
The user's core request and success criteria
Any clarifications or constraints they specified
2. Current State
What has been completed so far
Files created, modified, or analyzed (with paths if relevant)
Key outputs or artifacts produced
3. Important Discoveries
Technical constraints or requirements uncovered
Decisions made and their rationale
Errors encountered and how they were resolved
What approaches were tried that didn't work (and why)
4. Next Steps
Specific actions needed to complete the task
Any blockers or open questions to resolve
Priority order if multiple steps remain
5. Context to Preserve
User preferences or style requirements
Domain-specific details that aren't obvious
Any promises made to the user
Be concise but completeâ€”err on the side of including information that would prevent duplicate work or repeated mistakes. Write in a way that enables immediate resumption of the task.
Wrap your summary in <summary></summary> tags.`;var nt,Be,Re,U,rt,Y,ye,be,at,kr,gn;function $r(){let n,e;return{promise:new Promise((s,r)=>{n=s,e=r}),resolve:n,reject:e}}class Ta{constructor(e,t,s){nt.add(this),this.client=e,Be.set(this,!1),Re.set(this,!1),U.set(this,void 0),rt.set(this,void 0),Y.set(this,void 0),ye.set(this,void 0),be.set(this,void 0),at.set(this,0),y(this,U,{params:{...t,messages:structuredClone(t.messages)}}),y(this,rt,{...s,headers:M([{"x-stainless-helper":"BetaToolRunner"},s==null?void 0:s.headers])}),y(this,be,$r())}async*[(Be=new WeakMap,Re=new WeakMap,U=new WeakMap,rt=new WeakMap,Y=new WeakMap,ye=new WeakMap,be=new WeakMap,at=new WeakMap,nt=new WeakSet,kr=async function(){var h;const t=u(this,U,"f").params.compactionControl;if(!t||!t.enabled)return!1;let s=0;if(u(this,Y,"f")!==void 0)try{const m=await u(this,Y,"f");s=m.usage.input_tokens+(m.usage.cache_creation_input_tokens??0)+(m.usage.cache_read_input_tokens??0)+m.usage.output_tokens}catch{return!1}const r=t.contextTokenThreshold??ac;if(s<r)return!1;const a=t.model??u(this,U,"f").params.model,i=t.summaryPrompt??ic,o=u(this,U,"f").params.messages;if(o[o.length-1].role==="assistant"){const m=o[o.length-1];if(Array.isArray(m.content)){const f=m.content.filter(p=>p.type!=="tool_use");f.length===0?o.pop():m.content=f}}const c=await this.client.beta.messages.create({model:a,messages:[...o,{role:"user",content:[{type:"text",text:i}]}],max_tokens:u(this,U,"f").params.max_tokens},{headers:{"x-stainless-helper":"compaction"}});if(((h=c.content[0])==null?void 0:h.type)!=="text")throw new P("Expected text response for compaction");return u(this,U,"f").params.messages=[{role:"user",content:c.content}],!0},Symbol.asyncIterator)](){var e;if(u(this,Be,"f"))throw new P("Cannot iterate over a consumed stream");y(this,Be,!0),y(this,Re,!0),y(this,ye,void 0);try{for(;;){let t;try{if(u(this,U,"f").params.max_iterations&&u(this,at,"f")>=u(this,U,"f").params.max_iterations)break;y(this,Re,!1,"f"),y(this,ye,void 0,"f"),y(this,at,(e=u(this,at,"f"),e++,e),"f"),y(this,Y,void 0,"f");const{max_iterations:s,compactionControl:r,...a}=u(this,U,"f").params;if(a.stream?(t=this.client.beta.messages.stream({...a},u(this,rt,"f")),y(this,Y,t.finalMessage(),"f"),u(this,Y,"f").catch(()=>{}),yield t):(y(this,Y,this.client.beta.messages.create({...a,stream:!1},u(this,rt,"f")),"f"),yield u(this,Y,"f")),!await u(this,nt,"m",kr).call(this)){if(!u(this,Re,"f")){const{role:c,content:h}=await u(this,Y,"f");u(this,U,"f").params.messages.push({role:c,content:h})}const o=await u(this,nt,"m",gn).call(this,u(this,U,"f").params.messages.at(-1));if(o)u(this,U,"f").params.messages.push(o);else if(!u(this,Re,"f"))break}}finally{t&&t.abort()}}if(!u(this,Y,"f"))throw new P("ToolRunner concluded without a message from the server");u(this,be,"f").resolve(await u(this,Y,"f"))}catch(t){throw y(this,Be,!1),u(this,be,"f").promise.catch(()=>{}),u(this,be,"f").reject(t),y(this,be,$r()),t}}setMessagesParams(e){typeof e=="function"?u(this,U,"f").params=e(u(this,U,"f").params):u(this,U,"f").params=e,y(this,Re,!0),y(this,ye,void 0)}async generateToolResponse(){const e=await u(this,Y,"f")??this.params.messages.at(-1);return e?u(this,nt,"m",gn).call(this,e):null}done(){return u(this,be,"f").promise}async runUntilDone(){if(!u(this,Be,"f"))for await(const e of this);return this.done()}get params(){return u(this,U,"f").params}pushMessages(...e){this.setMessagesParams(t=>({...t,messages:[...t.messages,...e]}))}then(e,t){return this.runUntilDone().then(e,t)}}gn=async function(e){return u(this,ye,"f")!==void 0?u(this,ye,"f"):(y(this,ye,oc(u(this,U,"f").params,e)),u(this,ye,"f"))};async function oc(n,e=n.messages.at(-1)){if(!e||e.role!=="assistant"||!e.content||typeof e.content=="string")return null;const t=e.content.filter(r=>r.type==="tool_use");return t.length===0?null:{role:"user",content:await Promise.all(t.map(async r=>{const a=n.tools.find(i=>("name"in i?i.name:i.mcp_server_name)===r.name);if(!a||!("run"in a))return{type:"tool_result",tool_use_id:r.id,content:`Error: Tool '${r.name}' not found`,is_error:!0};try{let i=r.input;"parse"in a&&a.parse&&(i=a.parse(i));const o=await a.run(i);return{type:"tool_result",tool_use_id:r.id,content:o}}catch(i){return{type:"tool_result",tool_use_id:r.id,content:`Error: ${i instanceof Error?i.message:String(i)}`,is_error:!0}}}))}}class Is{constructor(e,t){this.iterator=e,this.controller=t}async*decoder(){const e=new It;for await(const t of this.iterator)for(const s of e.decode(t))yield JSON.parse(s);for(const t of e.flush())yield JSON.parse(t)}[Symbol.asyncIterator](){return this.decoder()}static fromResponse(e,t){if(!e.body)throw t.abort(),typeof globalThis.navigator<"u"&&globalThis.navigator.product==="ReactNative"?new P("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api"):new P("Attempted to iterate over a response with no body");return new Is(Mn(e.body),t)}}let Na=class extends ue{create(e,t){const{betas:s,...r}=e;return this._client.post("/v1/messages/batches?beta=true",{body:r,...t,headers:M([{"anthropic-beta":[...s??[],"message-batches-2024-09-24"].toString()},t==null?void 0:t.headers])})}retrieve(e,t={},s){const{betas:r}=t??{};return this._client.get(X`/v1/messages/batches/${e}?beta=true`,{...s,headers:M([{"anthropic-beta":[...r??[],"message-batches-2024-09-24"].toString()},s==null?void 0:s.headers])})}list(e={},t){const{betas:s,...r}=e??{};return this._client.getAPIList("/v1/messages/batches?beta=true",Mt,{query:r,...t,headers:M([{"anthropic-beta":[...s??[],"message-batches-2024-09-24"].toString()},t==null?void 0:t.headers])})}delete(e,t={},s){const{betas:r}=t??{};return this._client.delete(X`/v1/messages/batches/${e}?beta=true`,{...s,headers:M([{"anthropic-beta":[...r??[],"message-batches-2024-09-24"].toString()},s==null?void 0:s.headers])})}cancel(e,t={},s){const{betas:r}=t??{};return this._client.post(X`/v1/messages/batches/${e}/cancel?beta=true`,{...s,headers:M([{"anthropic-beta":[...r??[],"message-batches-2024-09-24"].toString()},s==null?void 0:s.headers])})}async results(e,t={},s){const r=await this.retrieve(e);if(!r.results_url)throw new P(`No batch \`results_url\`; Has it finished processing? ${r.processing_status} - ${r.id}`);const{betas:a}=t??{};return this._client.get(r.results_url,{...s,headers:M([{"anthropic-beta":[...a??[],"message-batches-2024-09-24"].toString(),Accept:"application/binary"},s==null?void 0:s.headers]),stream:!0,__binaryResponse:!0})._thenUnwrap((i,o)=>Is.fromResponse(o.response,o.controller))}};const Ar={"claude-1.3":"November 6th, 2024","claude-1.3-100k":"November 6th, 2024","claude-instant-1.1":"November 6th, 2024","claude-instant-1.1-100k":"November 6th, 2024","claude-instant-1.2":"November 6th, 2024","claude-3-sonnet-20240229":"July 21st, 2025","claude-3-opus-20240229":"January 5th, 2026","claude-2.1":"July 21st, 2025","claude-2.0":"July 21st, 2025","claude-3-7-sonnet-latest":"February 19th, 2026","claude-3-7-sonnet-20250219":"February 19th, 2026"};let Ms=class extends ue{constructor(){super(...arguments),this.batches=new Na(this._client)}create(e,t){const{betas:s,...r}=e;r.model in Ar&&console.warn(`The model '${r.model}' is deprecated and will reach end-of-life on ${Ar[r.model]}
Please migrate to a newer model. Visit https://docs.anthropic.com/en/docs/resources/model-deprecations for more information.`);let a=this._client._options.timeout;if(!r.stream&&a==null){const i=Ma[r.model]??void 0;a=this._client.calculateNonstreamingTimeout(r.max_tokens,i)}return this._client.post("/v1/messages?beta=true",{body:r,timeout:a??6e5,...t,headers:M([{...(s==null?void 0:s.toString())!=null?{"anthropic-beta":s==null?void 0:s.toString()}:void 0},t==null?void 0:t.headers]),stream:e.stream??!1})}parse(e,t){return t={...t,headers:M([{"anthropic-beta":[...e.betas??[],"structured-outputs-2025-11-13"].toString()},t==null?void 0:t.headers])},this.create(e,t).then(s=>Ca(s,e,{logger:this._client.logger??console}))}stream(e,t){return _s.createMessage(this,e,t)}countTokens(e,t){const{betas:s,...r}=e;return this._client.post("/v1/messages/count_tokens?beta=true",{body:r,...t,headers:M([{"anthropic-beta":[...s??[],"token-counting-2024-11-01"].toString()},t==null?void 0:t.headers])})}toolRunner(e,t){return new Ta(this._client,e,t)}};Ms.Batches=Na;Ms.BetaToolRunner=Ta;class Ba extends ue{create(e,t={},s){const{betas:r,...a}=t??{};return this._client.post(X`/v1/skills/${e}/versions?beta=true`,On({body:a,...s,headers:M([{"anthropic-beta":[...r??[],"skills-2025-10-02"].toString()},s==null?void 0:s.headers])},this._client))}retrieve(e,t,s){const{skill_id:r,betas:a}=t;return this._client.get(X`/v1/skills/${r}/versions/${e}?beta=true`,{...s,headers:M([{"anthropic-beta":[...a??[],"skills-2025-10-02"].toString()},s==null?void 0:s.headers])})}list(e,t={},s){const{betas:r,...a}=t??{};return this._client.getAPIList(X`/v1/skills/${e}/versions?beta=true`,ka,{query:a,...s,headers:M([{"anthropic-beta":[...r??[],"skills-2025-10-02"].toString()},s==null?void 0:s.headers])})}delete(e,t,s){const{skill_id:r,betas:a}=t;return this._client.delete(X`/v1/skills/${r}/versions/${e}?beta=true`,{...s,headers:M([{"anthropic-beta":[...a??[],"skills-2025-10-02"].toString()},s==null?void 0:s.headers])})}}class Tn extends ue{constructor(){super(...arguments),this.versions=new Ba(this._client)}create(e={},t){const{betas:s,...r}=e??{};return this._client.post("/v1/skills?beta=true",On({body:r,...t,headers:M([{"anthropic-beta":[...s??[],"skills-2025-10-02"].toString()},t==null?void 0:t.headers])},this._client))}retrieve(e,t={},s){const{betas:r}=t??{};return this._client.get(X`/v1/skills/${e}?beta=true`,{...s,headers:M([{"anthropic-beta":[...r??[],"skills-2025-10-02"].toString()},s==null?void 0:s.headers])})}list(e={},t){const{betas:s,...r}=e??{};return this._client.getAPIList("/v1/skills?beta=true",ka,{query:r,...t,headers:M([{"anthropic-beta":[...s??[],"skills-2025-10-02"].toString()},t==null?void 0:t.headers])})}delete(e,t={},s){const{betas:r}=t??{};return this._client.delete(X`/v1/skills/${e}?beta=true`,{...s,headers:M([{"anthropic-beta":[...r??[],"skills-2025-10-02"].toString()},s==null?void 0:s.headers])})}}Tn.Versions=Ba;let Ke=class extends ue{constructor(){super(...arguments),this.models=new Ia(this._client),this.messages=new Ms(this._client),this.files=new Ea(this._client),this.skills=new Tn(this._client)}};Ke.Models=Ia;Ke.Messages=Ms;Ke.Files=Ea;Ke.Skills=Tn;let La=class extends ue{create(e,t){const{betas:s,...r}=e;return this._client.post("/v1/complete",{body:r,timeout:this._client._options.timeout??6e5,...t,headers:M([{...(s==null?void 0:s.toString())!=null?{"anthropic-beta":s==null?void 0:s.toString()}:void 0},t==null?void 0:t.headers]),stream:e.stream??!1})}};var ie,Se,it,Jt,ot,ct,Xt,lt,ge,ut,Kt,Vt,ve,zt,Qt,Ks,Rr,Vs,zs,Qs,Gs,vr;const Pr="__json_buf";function Er(n){return n.type==="tool_use"||n.type==="server_tool_use"}class ys{constructor(){ie.add(this),this.messages=[],this.receivedMessages=[],Se.set(this,void 0),this.controller=new AbortController,it.set(this,void 0),Jt.set(this,()=>{}),ot.set(this,()=>{}),ct.set(this,void 0),Xt.set(this,()=>{}),lt.set(this,()=>{}),ge.set(this,{}),ut.set(this,!1),Kt.set(this,!1),Vt.set(this,!1),ve.set(this,!1),zt.set(this,void 0),Qt.set(this,void 0),Vs.set(this,e=>{if(y(this,Kt,!0),vt(e)&&(e=new le),e instanceof le)return y(this,Vt,!0),this._emit("abort",e);if(e instanceof P)return this._emit("error",e);if(e instanceof Error){const t=new P(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new P(String(e)))}),y(this,it,new Promise((e,t)=>{y(this,Jt,e,"f"),y(this,ot,t,"f")})),y(this,ct,new Promise((e,t)=>{y(this,Xt,e,"f"),y(this,lt,t,"f")})),u(this,it,"f").catch(()=>{}),u(this,ct,"f").catch(()=>{})}get response(){return u(this,zt,"f")}get request_id(){return u(this,Qt,"f")}async withResponse(){y(this,ve,!0);const e=await u(this,it,"f");if(!e)throw new Error("Could not resolve a `Response` object");return{data:this,response:e,request_id:e.headers.get("request-id")}}static fromReadableStream(e){const t=new ys;return t._run(()=>t._fromReadableStream(e)),t}static createMessage(e,t,s){const r=new ys;for(const a of t.messages)r._addMessageParam(a);return r._run(()=>r._createMessage(e,{...t,stream:!0},{...s,headers:{...s==null?void 0:s.headers,"X-Stainless-Helper-Method":"stream"}})),r}_run(e){e().then(()=>{this._emitFinal(),this._emit("end")},u(this,Vs,"f"))}_addMessageParam(e){this.messages.push(e)}_addMessage(e,t=!0){this.receivedMessages.push(e),t&&this._emit("message",e)}async _createMessage(e,t,s){var i;const r=s==null?void 0:s.signal;let a;r&&(r.aborted&&this.controller.abort(),a=this.controller.abort.bind(this.controller),r.addEventListener("abort",a));try{u(this,ie,"m",zs).call(this);const{response:o,data:c}=await e.create({...t,stream:!0},{...s,signal:this.controller.signal}).withResponse();this._connected(o);for await(const h of c)u(this,ie,"m",Qs).call(this,h);if((i=c.controller.signal)!=null&&i.aborted)throw new le;u(this,ie,"m",Gs).call(this)}finally{r&&a&&r.removeEventListener("abort",a)}}_connected(e){this.ended||(y(this,zt,e),y(this,Qt,e==null?void 0:e.headers.get("request-id")),u(this,Jt,"f").call(this,e),this._emit("connect"))}get ended(){return u(this,ut,"f")}get errored(){return u(this,Kt,"f")}get aborted(){return u(this,Vt,"f")}abort(){this.controller.abort()}on(e,t){return(u(this,ge,"f")[e]||(u(this,ge,"f")[e]=[])).push({listener:t}),this}off(e,t){const s=u(this,ge,"f")[e];if(!s)return this;const r=s.findIndex(a=>a.listener===t);return r>=0&&s.splice(r,1),this}once(e,t){return(u(this,ge,"f")[e]||(u(this,ge,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,s)=>{y(this,ve,!0),e!=="error"&&this.once("error",s),this.once(e,t)})}async done(){y(this,ve,!0),await u(this,ct,"f")}get currentMessage(){return u(this,Se,"f")}async finalMessage(){return await this.done(),u(this,ie,"m",Ks).call(this)}async finalText(){return await this.done(),u(this,ie,"m",Rr).call(this)}_emit(e,...t){if(u(this,ut,"f"))return;e==="end"&&(y(this,ut,!0),u(this,Xt,"f").call(this));const s=u(this,ge,"f")[e];if(s&&(u(this,ge,"f")[e]=s.filter(r=>!r.once),s.forEach(({listener:r})=>r(...t))),e==="abort"){const r=t[0];!u(this,ve,"f")&&!(s!=null&&s.length)&&Promise.reject(r),u(this,ot,"f").call(this,r),u(this,lt,"f").call(this,r),this._emit("end");return}if(e==="error"){const r=t[0];!u(this,ve,"f")&&!(s!=null&&s.length)&&Promise.reject(r),u(this,ot,"f").call(this,r),u(this,lt,"f").call(this,r),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalMessage",u(this,ie,"m",Ks).call(this))}async _fromReadableStream(e,t){var a;const s=t==null?void 0:t.signal;let r;s&&(s.aborted&&this.controller.abort(),r=this.controller.abort.bind(this.controller),s.addEventListener("abort",r));try{u(this,ie,"m",zs).call(this),this._connected(null);const i=Pt.fromReadableStream(e,this.controller);for await(const o of i)u(this,ie,"m",Qs).call(this,o);if((a=i.controller.signal)!=null&&a.aborted)throw new le;u(this,ie,"m",Gs).call(this)}finally{s&&r&&s.removeEventListener("abort",r)}}[(Se=new WeakMap,it=new WeakMap,Jt=new WeakMap,ot=new WeakMap,ct=new WeakMap,Xt=new WeakMap,lt=new WeakMap,ge=new WeakMap,ut=new WeakMap,Kt=new WeakMap,Vt=new WeakMap,ve=new WeakMap,zt=new WeakMap,Qt=new WeakMap,Vs=new WeakMap,ie=new WeakSet,Ks=function(){if(this.receivedMessages.length===0)throw new P("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},Rr=function(){if(this.receivedMessages.length===0)throw new P("stream ended without producing a Message with role=assistant");const t=this.receivedMessages.at(-1).content.filter(s=>s.type==="text").map(s=>s.text);if(t.length===0)throw new P("stream ended without producing a content block with type=text");return t.join(" ")},zs=function(){this.ended||y(this,Se,void 0)},Qs=function(t){if(this.ended)return;const s=u(this,ie,"m",vr).call(this,t);switch(this._emit("streamEvent",t,s),t.type){case"content_block_delta":{const r=s.content.at(-1);switch(t.delta.type){case"text_delta":{r.type==="text"&&this._emit("text",t.delta.text,r.text||"");break}case"citations_delta":{r.type==="text"&&this._emit("citation",t.delta.citation,r.citations??[]);break}case"input_json_delta":{Er(r)&&r.input&&this._emit("inputJson",t.delta.partial_json,r.input);break}case"thinking_delta":{r.type==="thinking"&&this._emit("thinking",t.delta.thinking,r.thinking);break}case"signature_delta":{r.type==="thinking"&&this._emit("signature",r.signature);break}default:t.delta}break}case"message_stop":{this._addMessageParam(s),this._addMessage(s,!0);break}case"content_block_stop":{this._emit("contentBlock",s.content.at(-1));break}case"message_start":{y(this,Se,s);break}}},Gs=function(){if(this.ended)throw new P("stream has ended, this shouldn't happen");const t=u(this,Se,"f");if(!t)throw new P("request ended without sending any chunks");return y(this,Se,void 0),t},vr=function(t){let s=u(this,Se,"f");if(t.type==="message_start"){if(s)throw new P(`Unexpected event order, got ${t.type} before receiving "message_stop"`);return t.message}if(!s)throw new P(`Unexpected event order, got ${t.type} before "message_start"`);switch(t.type){case"message_stop":return s;case"message_delta":return s.stop_reason=t.delta.stop_reason,s.stop_sequence=t.delta.stop_sequence,s.usage.output_tokens=t.usage.output_tokens,t.usage.input_tokens!=null&&(s.usage.input_tokens=t.usage.input_tokens),t.usage.cache_creation_input_tokens!=null&&(s.usage.cache_creation_input_tokens=t.usage.cache_creation_input_tokens),t.usage.cache_read_input_tokens!=null&&(s.usage.cache_read_input_tokens=t.usage.cache_read_input_tokens),t.usage.server_tool_use!=null&&(s.usage.server_tool_use=t.usage.server_tool_use),s;case"content_block_start":return s.content.push({...t.content_block}),s;case"content_block_delta":{const r=s.content.at(t.index);switch(t.delta.type){case"text_delta":{(r==null?void 0:r.type)==="text"&&(s.content[t.index]={...r,text:(r.text||"")+t.delta.text});break}case"citations_delta":{(r==null?void 0:r.type)==="text"&&(s.content[t.index]={...r,citations:[...r.citations??[],t.delta.citation]});break}case"input_json_delta":{if(r&&Er(r)){let a=r[Pr]||"";a+=t.delta.partial_json;const i={...r};Object.defineProperty(i,Pr,{value:a,enumerable:!1,writable:!0}),a&&(i.input=Oa(a)),s.content[t.index]=i}break}case"thinking_delta":{(r==null?void 0:r.type)==="thinking"&&(s.content[t.index]={...r,thinking:r.thinking+t.delta.thinking});break}case"signature_delta":{(r==null?void 0:r.type)==="thinking"&&(s.content[t.index]={...r,signature:t.delta.signature});break}default:t.delta}return s}case"content_block_stop":return s}},Symbol.asyncIterator)](){const e=[],t=[];let s=!1;return this.on("streamEvent",r=>{const a=t.shift();a?a.resolve(r):e.push(r)}),this.on("end",()=>{s=!0;for(const r of t)r.resolve(void 0);t.length=0}),this.on("abort",r=>{s=!0;for(const a of t)a.reject(r);t.length=0}),this.on("error",r=>{s=!0;for(const a of t)a.reject(r);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:s?{value:void 0,done:!0}:new Promise((a,i)=>t.push({resolve:a,reject:i})).then(a=>a?{value:a,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new Pt(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}let Fa=class extends ue{create(e,t){return this._client.post("/v1/messages/batches",{body:e,...t})}retrieve(e,t){return this._client.get(X`/v1/messages/batches/${e}`,t)}list(e={},t){return this._client.getAPIList("/v1/messages/batches",Mt,{query:e,...t})}delete(e,t){return this._client.delete(X`/v1/messages/batches/${e}`,t)}cancel(e,t){return this._client.post(X`/v1/messages/batches/${e}/cancel`,t)}async results(e,t){const s=await this.retrieve(e);if(!s.results_url)throw new P(`No batch \`results_url\`; Has it finished processing? ${s.processing_status} - ${s.id}`);return this._client.get(s.results_url,{...t,headers:M([{Accept:"application/binary"},t==null?void 0:t.headers]),stream:!0,__binaryResponse:!0})._thenUnwrap((r,a)=>Is.fromResponse(a.response,a.controller))}},Nn=class extends ue{constructor(){super(...arguments),this.batches=new Fa(this._client)}create(e,t){e.model in Ir&&console.warn(`The model '${e.model}' is deprecated and will reach end-of-life on ${Ir[e.model]}
Please migrate to a newer model. Visit https://docs.anthropic.com/en/docs/resources/model-deprecations for more information.`);let s=this._client._options.timeout;if(!e.stream&&s==null){const r=Ma[e.model]??void 0;s=this._client.calculateNonstreamingTimeout(e.max_tokens,r)}return this._client.post("/v1/messages",{body:e,timeout:s??6e5,...t,stream:e.stream??!1})}stream(e,t){return ys.createMessage(this,e,t)}countTokens(e,t){return this._client.post("/v1/messages/count_tokens",{body:e,...t})}};const Ir={"claude-1.3":"November 6th, 2024","claude-1.3-100k":"November 6th, 2024","claude-instant-1.1":"November 6th, 2024","claude-instant-1.1-100k":"November 6th, 2024","claude-instant-1.2":"November 6th, 2024","claude-3-sonnet-20240229":"July 21st, 2025","claude-3-opus-20240229":"January 5th, 2026","claude-2.1":"July 21st, 2025","claude-2.0":"July 21st, 2025","claude-3-7-sonnet-latest":"February 19th, 2026","claude-3-7-sonnet-20250219":"February 19th, 2026"};Nn.Batches=Fa;let ja=class extends ue{retrieve(e,t={},s){const{betas:r}=t??{};return this._client.get(X`/v1/models/${e}`,{...s,headers:M([{...(r==null?void 0:r.toString())!=null?{"anthropic-beta":r==null?void 0:r.toString()}:void 0},s==null?void 0:s.headers])})}list(e={},t){const{betas:s,...r}=e??{};return this._client.getAPIList("/v1/models",Mt,{query:r,...t,headers:M([{...(s==null?void 0:s.toString())!=null?{"anthropic-beta":s==null?void 0:s.toString()}:void 0},t==null?void 0:t.headers])})}};var Ys={};const Gt=n=>{var e,t,s,r;if(typeof globalThis.process<"u")return((e=Ys==null?void 0:Ys[n])==null?void 0:e.trim())??void 0;if(typeof globalThis.Deno<"u")return(r=(s=(t=globalThis.Deno.env)==null?void 0:t.get)==null?void 0:s.call(t,n))==null?void 0:r.trim()};var pn,Bn,is,qa;const cc="\\n\\nHuman:",lc="\\n\\nAssistant:";class j{constructor({baseURL:e=Gt("ANTHROPIC_BASE_URL"),apiKey:t=Gt("ANTHROPIC_API_KEY")??null,authToken:s=Gt("ANTHROPIC_AUTH_TOKEN")??null,...r}={}){pn.add(this),is.set(this,void 0);const a={apiKey:t,authToken:s,...r,baseURL:e||"https://api.anthropic.com"};if(!a.dangerouslyAllowBrowser&&Eo())throw new P(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new Anthropic({ apiKey, dangerouslyAllowBrowser: true });
`);this.baseURL=a.baseURL,this.timeout=a.timeout??Bn.DEFAULT_TIMEOUT,this.logger=a.logger??console;const i="warn";this.logLevel=i,this.logLevel=mr(a.logLevel,"ClientOptions.logLevel",this)??mr(Gt("ANTHROPIC_LOG"),"process.env['ANTHROPIC_LOG']",this)??i,this.fetchOptions=a.fetchOptions,this.maxRetries=a.maxRetries??2,this.fetch=a.fetch??To(),y(this,is,Bo),this._options=a,this.apiKey=typeof t=="string"?t:null,this.authToken=s}withOptions(e){return new this.constructor({...this._options,baseURL:this.baseURL,maxRetries:this.maxRetries,timeout:this.timeout,logger:this.logger,logLevel:this.logLevel,fetch:this.fetch,fetchOptions:this.fetchOptions,apiKey:this.apiKey,authToken:this.authToken,...e})}defaultQuery(){return this._options.defaultQuery}validateHeaders({values:e,nulls:t}){if(!(e.get("x-api-key")||e.get("authorization"))&&!(this.apiKey&&e.get("x-api-key"))&&!t.has("x-api-key")&&!(this.authToken&&e.get("authorization"))&&!t.has("authorization"))throw new Error('Could not resolve authentication method. Expected either apiKey or authToken to be set. Or for one of the "X-Api-Key" or "Authorization" headers to be explicitly omitted')}async authHeaders(e){return M([await this.apiKeyAuth(e),await this.bearerAuth(e)])}async apiKeyAuth(e){if(this.apiKey!=null)return M([{"X-Api-Key":this.apiKey}])}async bearerAuth(e){if(this.authToken!=null)return M([{Authorization:`Bearer ${this.authToken}`}])}stringifyQuery(e){return Object.entries(e).filter(([t,s])=>typeof s<"u").map(([t,s])=>{if(typeof s=="string"||typeof s=="number"||typeof s=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(s)}`;if(s===null)return`${encodeURIComponent(t)}=`;throw new P(`Cannot stringify type ${typeof s}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}getUserAgent(){return`${this.constructor.name}/JS ${qe}`}defaultIdempotencyKey(){return`stainless-node-retry-${aa()}`}makeStatusError(e,t,s,r){return re.generate(e,t,s,r)}buildURL(e,t,s){const r=!u(this,pn,"m",qa).call(this)&&s||this.baseURL,a=$o(e)?new URL(e):new URL(r+(r.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),i=this.defaultQuery();return Ao(i)||(t={...i,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(a.search=this.stringifyQuery(t)),a.toString()}_calculateNonstreamingTimeout(e){if(3600*e/128e3>600)throw new P("Streaming is required for operations that may take longer than 10 minutes. See https://github.com/anthropics/anthropic-sdk-typescript#streaming-responses for more details");return 600*1e3}async prepareOptions(e){}async prepareRequest(e,{url:t,options:s}){}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,s){return this.request(Promise.resolve(s).then(r=>({method:e,path:t,...r})))}request(e,t=null){return new ba(this,this.makeRequest(e,t,void 0))}async makeRequest(e,t,s){var L,$;const r=await e,a=r.maxRetries??this.maxRetries;t==null&&(t=a),await this.prepareOptions(r);const{req:i,url:o,timeout:c}=await this.buildRequest(r,{retryCount:a-t});await this.prepareRequest(i,{url:o,options:r});const h="log_"+(Math.random()*(1<<24)|0).toString(16).padStart(6,"0"),m=s===void 0?"":`, retryOf: ${s}`,f=Date.now();if(z(this).debug(`[${h}] sending request`,Pe({retryOfRequestLogID:s,method:r.method,url:o,options:r,headers:i.headers})),(L=r.signal)!=null&&L.aborted)throw new le;const p=new AbortController,d=await this.fetchWithTimeout(o,i,c,p).catch(ln),_=Date.now();if(d instanceof globalThis.Error){const R=`retrying, ${t} attempts remaining`;if(($=r.signal)!=null&&$.aborted)throw new le;const S=vt(d)||/timed? ?out/i.test(String(d)+("cause"in d?String(d.cause):""));if(t)return z(this).info(`[${h}] connection ${S?"timed out":"failed"} - ${R}`),z(this).debug(`[${h}] connection ${S?"timed out":"failed"} (${R})`,Pe({retryOfRequestLogID:s,url:o,durationMs:_-f,message:d.message})),this.retryRequest(r,t,s??h);throw z(this).info(`[${h}] connection ${S?"timed out":"failed"} - error; no more retries left`),z(this).debug(`[${h}] connection ${S?"timed out":"failed"} (error; no more retries left)`,Pe({retryOfRequestLogID:s,url:o,durationMs:_-f,message:d.message})),S?new ia:new Es({cause:d})}const b=[...d.headers.entries()].filter(([R])=>R==="request-id").map(([R,S])=>", "+R+": "+JSON.stringify(S)).join(""),A=`[${h}${m}${b}] ${i.method} ${o} ${d.ok?"succeeded":"failed"} with status ${d.status} in ${_-f}ms`;if(!d.ok){const R=await this.shouldRetry(d);if(t&&R){const C=`retrying, ${t} attempts remaining`;return await No(d.body),z(this).info(`${A} - ${C}`),z(this).debug(`[${h}] response error (${C})`,Pe({retryOfRequestLogID:s,url:d.url,status:d.status,headers:d.headers,durationMs:_-f})),this.retryRequest(r,t,s??h,d.headers)}const S=R?"error; no more retries left":"error; not retryable";z(this).info(`${A} - ${S}`);const N=await d.text().catch(C=>ln(C).message),O=ga(N),I=O?void 0:N;throw z(this).debug(`[${h}] response error (${S})`,Pe({retryOfRequestLogID:s,url:d.url,status:d.status,headers:d.headers,message:I,durationMs:Date.now()-f})),this.makeStatusError(d.status,O,I,d.headers)}return z(this).info(A),z(this).debug(`[${h}] response start`,Pe({retryOfRequestLogID:s,url:d.url,status:d.status,headers:d.headers,durationMs:_-f})),{response:d,options:r,controller:p,requestLogID:h,retryOfRequestLogID:s,startTime:f}}getAPIList(e,t,s){return this.requestAPIList(t,{method:"get",path:e,...s})}requestAPIList(e,t){const s=this.makeRequest(t,null,void 0);return new Jo(this,s,e)}async fetchWithTimeout(e,t,s,r){const{signal:a,method:i,...o}=t||{};a&&a.addEventListener("abort",()=>r.abort());const c=setTimeout(()=>r.abort(),s),h=globalThis.ReadableStream&&o.body instanceof globalThis.ReadableStream||typeof o.body=="object"&&o.body!==null&&Symbol.asyncIterator in o.body,m={signal:r.signal,...h?{duplex:"half"}:{},method:"GET",...o};i&&(m.method=i.toUpperCase());try{return await this.fetch.call(void 0,e,m)}finally{clearTimeout(c)}}async shouldRetry(e){const t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,s,r){let a;const i=r==null?void 0:r.get("retry-after-ms");if(i){const c=parseFloat(i);Number.isNaN(c)||(a=c)}const o=r==null?void 0:r.get("retry-after");if(o&&!a){const c=parseFloat(o);Number.isNaN(c)?a=Date.parse(o)-Date.now():a=c*1e3}if(!(a&&0<=a&&a<60*1e3)){const c=e.maxRetries??this.maxRetries;a=this.calculateDefaultRetryTimeoutMillis(t,c)}return await Po(a),this.makeRequest(e,t-1,s)}calculateDefaultRetryTimeoutMillis(e,t){const a=t-e,i=Math.min(.5*Math.pow(2,a),8),o=1-Math.random()*.25;return i*o*1e3}calculateNonstreamingTimeout(e,t){if(36e5*e/128e3>6e5||t!=null&&e>t)throw new P("Streaming is required for operations that may take longer than 10 minutes. See https://github.com/anthropics/anthropic-sdk-typescript#long-requests for more details");return 6e5}async buildRequest(e,{retryCount:t=0}={}){const s={...e},{method:r,path:a,query:i,defaultBaseURL:o}=s,c=this.buildURL(a,i,o);"timeout"in s&&vo("timeout",s.timeout),s.timeout=s.timeout??this.timeout;const{bodyHeaders:h,body:m}=this.buildBody({options:s}),f=await this.buildHeaders({options:e,method:r,bodyHeaders:h,retryCount:t});return{req:{method:r,headers:f,...s.signal&&{signal:s.signal},...globalThis.ReadableStream&&m instanceof globalThis.ReadableStream&&{duplex:"half"},...m&&{body:m},...this.fetchOptions??{},...s.fetchOptions??{}},url:c,timeout:s.timeout}}async buildHeaders({options:e,method:t,bodyHeaders:s,retryCount:r}){let a={};this.idempotencyHeader&&t!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),a[this.idempotencyHeader]=e.idempotencyKey);const i=M([a,{Accept:"application/json","User-Agent":this.getUserAgent(),"X-Stainless-Retry-Count":String(r),...e.timeout?{"X-Stainless-Timeout":String(Math.trunc(e.timeout/1e3))}:{},...Oo(),...this._options.dangerouslyAllowBrowser?{"anthropic-dangerous-direct-browser-access":"true"}:void 0,"anthropic-version":"2023-06-01"},await this.authHeaders(e),this._options.defaultHeaders,s,e.headers]);return this.validateHeaders(i),i.values}buildBody({options:{body:e,headers:t}}){if(!e)return{bodyHeaders:void 0,body:void 0};const s=M([t]);return ArrayBuffer.isView(e)||e instanceof ArrayBuffer||e instanceof DataView||typeof e=="string"&&s.values.has("content-type")||globalThis.Blob&&e instanceof globalThis.Blob||e instanceof FormData||e instanceof URLSearchParams||globalThis.ReadableStream&&e instanceof globalThis.ReadableStream?{bodyHeaders:void 0,body:e}:typeof e=="object"&&(Symbol.asyncIterator in e||Symbol.iterator in e&&"next"in e&&typeof e.next=="function")?{bodyHeaders:void 0,body:_a(e)}:u(this,is,"f").call(this,{body:e,headers:s})}}Bn=j,is=new WeakMap,pn=new WeakSet,qa=function(){return this.baseURL!=="https://api.anthropic.com"};j.Anthropic=Bn;j.HUMAN_PROMPT=cc;j.AI_PROMPT=lc;j.DEFAULT_TIMEOUT=6e5;j.AnthropicError=P;j.APIError=re;j.APIConnectionError=Es;j.APIConnectionTimeoutError=ia;j.APIUserAbortError=le;j.NotFoundError=ua;j.ConflictError=ha;j.RateLimitError=fa;j.BadRequestError=oa;j.AuthenticationError=ca;j.InternalServerError=ma;j.PermissionDeniedError=la;j.UnprocessableEntityError=da;j.toFile=Go;class Ct extends j{constructor(){super(...arguments),this.completions=new La(this),this.messages=new Nn(this),this.models=new ja(this),this.beta=new Ke(this)}}Ct.Completions=La;Ct.Messages=Nn;Ct.Models=ja;Ct.Beta=Ke;function v(n,e,t,s,r){if(typeof e=="function"?n!==e||!0:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return e.set(n,t),t}function l(n,e,t,s){if(t==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?s:t==="a"?s.call(n):s?s.value:e.get(n)}let Ua=function(){const{crypto:n}=globalThis;if(n!=null&&n.randomUUID)return Ua=n.randomUUID.bind(n),n.randomUUID();const e=new Uint8Array(1),t=n?()=>n.getRandomValues(e)[0]:()=>Math.random()*255&255;return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,s=>(+s^t()&15>>+s/4).toString(16))};function _n(n){return typeof n=="object"&&n!==null&&("name"in n&&n.name==="AbortError"||"message"in n&&String(n.message).includes("FetchRequestCanceledException"))}const yn=n=>{if(n instanceof Error)return n;if(typeof n=="object"&&n!==null){try{if(Object.prototype.toString.call(n)==="[object Error]"){const e=new Error(n.message,n.cause?{cause:n.cause}:{});return n.stack&&(e.stack=n.stack),n.cause&&!e.cause&&(e.cause=n.cause),n.name&&(e.name=n.name),e}}catch{}try{return new Error(JSON.stringify(n))}catch{}}return new Error(n)};class k extends Error{}class K extends k{constructor(e,t,s,r){super(`${K.makeMessage(e,t,s)}`),this.status=e,this.headers=r,this.requestID=r==null?void 0:r.get("x-request-id"),this.error=t;const a=t;this.code=a==null?void 0:a.code,this.param=a==null?void 0:a.param,this.type=a==null?void 0:a.type}static makeMessage(e,t,s){const r=t!=null&&t.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):s;return e&&r?`${e} ${r}`:e?`${e} status code (no body)`:r||"(no status code or body)"}static generate(e,t,s,r){if(!e||!r)return new Cs({message:s,cause:yn(t)});const a=t==null?void 0:t.error;return e===400?new Wa(e,a,s,r):e===401?new Da(e,a,s,r):e===403?new Ha(e,a,s,r):e===404?new Ja(e,a,s,r):e===409?new Xa(e,a,s,r):e===422?new Ka(e,a,s,r):e===429?new Va(e,a,s,r):e>=500?new za(e,a,s,r):new K(e,a,s,r)}}class oe extends K{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}}class Cs extends K{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}}class Ln extends Cs{constructor({message:e}={}){super({message:e??"Request timed out."})}}class Wa extends K{}class Da extends K{}class Ha extends K{}class Ja extends K{}class Xa extends K{}class Ka extends K{}class Va extends K{}class za extends K{}class Qa extends k{constructor(){super("Could not parse response content as the length limit was reached")}}class Ga extends k{constructor(){super("Could not parse response content as the request was rejected by the content filter")}}class gt extends Error{constructor(e){super(e)}}const uc=/^[a-z][a-z0-9+.-]*:/i,hc=n=>uc.test(n);let G=n=>(G=Array.isArray,G(n)),Mr=G;function Ya(n){return typeof n!="object"?{}:n??{}}function dc(n){if(!n)return!0;for(const e in n)return!1;return!0}function fc(n,e){return Object.prototype.hasOwnProperty.call(n,e)}function Zs(n){return n!=null&&typeof n=="object"&&!Array.isArray(n)}const mc=(n,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new k(`${n} must be an integer`);if(e<0)throw new k(`${n} must be a positive integer`);return e},gc=n=>{try{return JSON.parse(n)}catch{return}},Ot=n=>new Promise(e=>setTimeout(e,n)),We="6.15.0",pc=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u";function _c(){return typeof Deno<"u"&&Deno.build!=null?"deno":typeof EdgeRuntime<"u"?"edge":Object.prototype.toString.call(typeof globalThis.process<"u"?globalThis.process:0)==="[object process]"?"node":"unknown"}const yc=()=>{var t;const n=_c();if(n==="deno")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":We,"X-Stainless-OS":Or(Deno.build.os),"X-Stainless-Arch":Cr(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:((t=Deno.version)==null?void 0:t.deno)??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":We,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":globalThis.process.version};if(n==="node")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":We,"X-Stainless-OS":Or(globalThis.process.platform??"unknown"),"X-Stainless-Arch":Cr(globalThis.process.arch??"unknown"),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":globalThis.process.version??"unknown"};const e=wc();return e?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":We,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${e.browser}`,"X-Stainless-Runtime-Version":e.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":We,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function wc(){if(typeof navigator>"u"||!navigator)return null;const n=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:e,pattern:t}of n){const s=t.exec(navigator.userAgent);if(s){const r=s[1]||0,a=s[2]||0,i=s[3]||0;return{browser:e,version:`${r}.${a}.${i}`}}}return null}const Cr=n=>n==="x32"?"x32":n==="x86_64"||n==="x64"?"x64":n==="arm"?"arm":n==="aarch64"||n==="arm64"?"arm64":n?`other:${n}`:"unknown",Or=n=>(n=n.toLowerCase(),n.includes("ios")?"iOS":n==="android"?"Android":n==="darwin"?"MacOS":n==="win32"?"Windows":n==="freebsd"?"FreeBSD":n==="openbsd"?"OpenBSD":n==="linux"?"Linux":n?`Other:${n}`:"Unknown");let Tr;const bc=()=>Tr??(Tr=yc());function Sc(){if(typeof fetch<"u")return fetch;throw new Error("`fetch` is not defined as a global; Either pass `fetch` to the client, `new OpenAI({ fetch })` or polyfill the global, `globalThis.fetch = fetch`")}function Za(...n){const e=globalThis.ReadableStream;if(typeof e>"u")throw new Error("`ReadableStream` is not defined as a global; You will need to polyfill it, `globalThis.ReadableStream = ReadableStream`");return new e(...n)}function ei(n){let e=Symbol.asyncIterator in n?n[Symbol.asyncIterator]():n[Symbol.iterator]();return Za({start(){},async pull(t){const{done:s,value:r}=await e.next();s?t.close():t.enqueue(r)},async cancel(){var t;await((t=e.return)==null?void 0:t.call(e))}})}function ti(n){if(n[Symbol.asyncIterator])return n;const e=n.getReader();return{async next(){try{const t=await e.read();return t!=null&&t.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){const t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}async function xc(n){var s,r;if(n===null||typeof n!="object")return;if(n[Symbol.asyncIterator]){await((r=(s=n[Symbol.asyncIterator]()).return)==null?void 0:r.call(s));return}const e=n.getReader(),t=e.cancel();e.releaseLock(),await t}const kc=({headers:n,body:e})=>({bodyHeaders:{"content-type":"application/json"},body:JSON.stringify(e)}),si="RFC3986",ni=n=>String(n),Nr={RFC1738:n=>String(n).replace(/%20/g,"+"),RFC3986:ni},$c="RFC1738";let wn=(n,e)=>(wn=Object.hasOwn??Function.prototype.call.bind(Object.prototype.hasOwnProperty),wn(n,e));const he=(()=>{const n=[];for(let e=0;e<256;++e)n.push("%"+((e<16?"0":"")+e.toString(16)).toUpperCase());return n})(),en=1024,Ac=(n,e,t,s,r)=>{if(n.length===0)return n;let a=n;if(typeof n=="symbol"?a=Symbol.prototype.toString.call(n):typeof n!="string"&&(a=String(n)),t==="iso-8859-1")return escape(a).replace(/%u[0-9a-f]{4}/gi,function(o){return"%26%23"+parseInt(o.slice(2),16)+"%3B"});let i="";for(let o=0;o<a.length;o+=en){const c=a.length>=en?a.slice(o,o+en):a,h=[];for(let m=0;m<c.length;++m){let f=c.charCodeAt(m);if(f===45||f===46||f===95||f===126||f>=48&&f<=57||f>=65&&f<=90||f>=97&&f<=122||r===$c&&(f===40||f===41)){h[h.length]=c.charAt(m);continue}if(f<128){h[h.length]=he[f];continue}if(f<2048){h[h.length]=he[192|f>>6]+he[128|f&63];continue}if(f<55296||f>=57344){h[h.length]=he[224|f>>12]+he[128|f>>6&63]+he[128|f&63];continue}m+=1,f=65536+((f&1023)<<10|c.charCodeAt(m)&1023),h[h.length]=he[240|f>>18]+he[128|f>>12&63]+he[128|f>>6&63]+he[128|f&63]}i+=h.join("")}return i};function Rc(n){return!n||typeof n!="object"?!1:!!(n.constructor&&n.constructor.isBuffer&&n.constructor.isBuffer(n))}function Br(n,e){if(G(n)){const t=[];for(let s=0;s<n.length;s+=1)t.push(e(n[s]));return t}return e(n)}const ri={brackets(n){return String(n)+"[]"},comma:"comma",indices(n,e){return String(n)+"["+e+"]"},repeat(n){return String(n)}},ai=function(n,e){Array.prototype.push.apply(n,G(e)?e:[e])};let Lr;const W={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:Ac,encodeValuesOnly:!1,format:si,formatter:ni,indices:!1,serializeDate(n){return(Lr??(Lr=Function.prototype.call.bind(Date.prototype.toISOString)))(n)},skipNulls:!1,strictNullHandling:!1};function vc(n){return typeof n=="string"||typeof n=="number"||typeof n=="boolean"||typeof n=="symbol"||typeof n=="bigint"}const tn={};function ii(n,e,t,s,r,a,i,o,c,h,m,f,p,d,_,b,A,L){let $=n,R=L,S=0,N=!1;for(;(R=R.get(tn))!==void 0&&!N;){const B=R.get(n);if(S+=1,typeof B<"u"){if(B===S)throw new RangeError("Cyclic object value");N=!0}typeof R.get(tn)>"u"&&(S=0)}if(typeof h=="function"?$=h(e,$):$ instanceof Date?$=p==null?void 0:p($):t==="comma"&&G($)&&($=Br($,function(B){return B instanceof Date?p==null?void 0:p(B):B})),$===null){if(a)return c&&!b?c(e,W.encoder,A,"key",d):e;$=""}if(vc($)||Rc($)){if(c){const B=b?e:c(e,W.encoder,A,"key",d);return[(_==null?void 0:_(B))+"="+(_==null?void 0:_(c($,W.encoder,A,"value",d)))]}return[(_==null?void 0:_(e))+"="+(_==null?void 0:_(String($)))]}const O=[];if(typeof $>"u")return O;let I;if(t==="comma"&&G($))b&&c&&($=Br($,c)),I=[{value:$.length>0?$.join(",")||null:void 0}];else if(G(h))I=h;else{const B=Object.keys($);I=m?B.sort(m):B}const Q=o?String(e).replace(/\./g,"%2E"):String(e),C=s&&G($)&&$.length===1?Q+"[]":Q;if(r&&G($)&&$.length===0)return C+"[]";for(let B=0;B<I.length;++B){const T=I[B],Te=typeof T=="object"&&typeof T.value<"u"?T.value:$[T];if(i&&Te===null)continue;const Ws=f&&o?T.replace(/\./g,"%2E"):T,xo=G($)?typeof t=="function"?t(C,Ws):C:C+(f?"."+Ws:"["+Ws+"]");L.set(n,S);const ir=new WeakMap;ir.set(tn,L),ai(O,ii(Te,xo,t,s,r,a,i,o,t==="comma"&&b&&G($)?null:c,h,m,f,p,d,_,b,A,ir))}return O}function Pc(n=W){if(typeof n.allowEmptyArrays<"u"&&typeof n.allowEmptyArrays!="boolean")throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(typeof n.encodeDotInKeys<"u"&&typeof n.encodeDotInKeys!="boolean")throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(n.encoder!==null&&typeof n.encoder<"u"&&typeof n.encoder!="function")throw new TypeError("Encoder has to be a function.");const e=n.charset||W.charset;if(typeof n.charset<"u"&&n.charset!=="utf-8"&&n.charset!=="iso-8859-1")throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let t=si;if(typeof n.format<"u"){if(!wn(Nr,n.format))throw new TypeError("Unknown format option provided.");t=n.format}const s=Nr[t];let r=W.filter;(typeof n.filter=="function"||G(n.filter))&&(r=n.filter);let a;if(n.arrayFormat&&n.arrayFormat in ri?a=n.arrayFormat:"indices"in n?a=n.indices?"indices":"repeat":a=W.arrayFormat,"commaRoundTrip"in n&&typeof n.commaRoundTrip!="boolean")throw new TypeError("`commaRoundTrip` must be a boolean, or absent");const i=typeof n.allowDots>"u"?n.encodeDotInKeys?!0:W.allowDots:!!n.allowDots;return{addQueryPrefix:typeof n.addQueryPrefix=="boolean"?n.addQueryPrefix:W.addQueryPrefix,allowDots:i,allowEmptyArrays:typeof n.allowEmptyArrays=="boolean"?!!n.allowEmptyArrays:W.allowEmptyArrays,arrayFormat:a,charset:e,charsetSentinel:typeof n.charsetSentinel=="boolean"?n.charsetSentinel:W.charsetSentinel,commaRoundTrip:!!n.commaRoundTrip,delimiter:typeof n.delimiter>"u"?W.delimiter:n.delimiter,encode:typeof n.encode=="boolean"?n.encode:W.encode,encodeDotInKeys:typeof n.encodeDotInKeys=="boolean"?n.encodeDotInKeys:W.encodeDotInKeys,encoder:typeof n.encoder=="function"?n.encoder:W.encoder,encodeValuesOnly:typeof n.encodeValuesOnly=="boolean"?n.encodeValuesOnly:W.encodeValuesOnly,filter:r,format:t,formatter:s,serializeDate:typeof n.serializeDate=="function"?n.serializeDate:W.serializeDate,skipNulls:typeof n.skipNulls=="boolean"?n.skipNulls:W.skipNulls,sort:typeof n.sort=="function"?n.sort:null,strictNullHandling:typeof n.strictNullHandling=="boolean"?n.strictNullHandling:W.strictNullHandling}}function Ec(n,e={}){let t=n;const s=Pc(e);let r,a;typeof s.filter=="function"?(a=s.filter,t=a("",t)):G(s.filter)&&(a=s.filter,r=a);const i=[];if(typeof t!="object"||t===null)return"";const o=ri[s.arrayFormat],c=o==="comma"&&s.commaRoundTrip;r||(r=Object.keys(t)),s.sort&&r.sort(s.sort);const h=new WeakMap;for(let p=0;p<r.length;++p){const d=r[p];s.skipNulls&&t[d]===null||ai(i,ii(t[d],d,o,c,s.allowEmptyArrays,s.strictNullHandling,s.skipNulls,s.encodeDotInKeys,s.encode?s.encoder:null,s.filter,s.sort,s.allowDots,s.serializeDate,s.format,s.formatter,s.encodeValuesOnly,s.charset,h))}const m=i.join(s.delimiter);let f=s.addQueryPrefix===!0?"?":"";return s.charsetSentinel&&(s.charset==="iso-8859-1"?f+="utf8=%26%2310003%3B&":f+="utf8=%E2%9C%93&"),m.length>0?f+m:""}function Ic(n){let e=0;for(const r of n)e+=r.length;const t=new Uint8Array(e);let s=0;for(const r of n)t.set(r,s),s+=r.length;return t}let Fr;function Fn(n){let e;return(Fr??(e=new globalThis.TextEncoder,Fr=e.encode.bind(e)))(n)}let jr;function qr(n){let e;return(jr??(e=new globalThis.TextDecoder,jr=e.decode.bind(e)))(n)}var te,se;class Os{constructor(){te.set(this,void 0),se.set(this,void 0),v(this,te,new Uint8Array),v(this,se,null)}decode(e){if(e==null)return[];const t=e instanceof ArrayBuffer?new Uint8Array(e):typeof e=="string"?Fn(e):e;v(this,te,Ic([l(this,te,"f"),t]));const s=[];let r;for(;(r=Mc(l(this,te,"f"),l(this,se,"f")))!=null;){if(r.carriage&&l(this,se,"f")==null){v(this,se,r.index);continue}if(l(this,se,"f")!=null&&(r.index!==l(this,se,"f")+1||r.carriage)){s.push(qr(l(this,te,"f").subarray(0,l(this,se,"f")-1))),v(this,te,l(this,te,"f").subarray(l(this,se,"f"))),v(this,se,null);continue}const a=l(this,se,"f")!==null?r.preceding-1:r.preceding,i=qr(l(this,te,"f").subarray(0,a));s.push(i),v(this,te,l(this,te,"f").subarray(r.index)),v(this,se,null)}return s}flush(){return l(this,te,"f").length?this.decode(`
`):[]}}te=new WeakMap,se=new WeakMap;Os.NEWLINE_CHARS=new Set([`
`,"\r"]);Os.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function Mc(n,e){for(let r=e??0;r<n.length;r++){if(n[r]===10)return{preceding:r,index:r+1,carriage:!1};if(n[r]===13)return{preceding:r,index:r+1,carriage:!0}}return null}function Cc(n){for(let s=0;s<n.length-1;s++){if(n[s]===10&&n[s+1]===10||n[s]===13&&n[s+1]===13)return s+2;if(n[s]===13&&n[s+1]===10&&s+3<n.length&&n[s+2]===13&&n[s+3]===10)return s+4}return-1}const ws={off:0,error:200,warn:300,info:400,debug:500},Ur=(n,e,t)=>{if(n){if(fc(ws,n))return n;H(t).warn(`${e} was set to ${JSON.stringify(n)}, expected one of ${JSON.stringify(Object.keys(ws))}`)}};function pt(){}function Yt(n,e,t){return!e||ws[n]>ws[t]?pt:e[n].bind(e)}const Oc={error:pt,warn:pt,info:pt,debug:pt};let Wr=new WeakMap;function H(n){const e=n.logger,t=n.logLevel??"off";if(!e)return Oc;const s=Wr.get(e);if(s&&s[0]===t)return s[1];const r={error:Yt("error",e,t),warn:Yt("warn",e,t),info:Yt("info",e,t),debug:Yt("debug",e,t)};return Wr.set(e,[t,r]),r}const Ee=n=>(n.options&&(n.options={...n.options},delete n.options.headers),n.headers&&(n.headers=Object.fromEntries((n.headers instanceof Headers?[...n.headers]:Object.entries(n.headers)).map(([e,t])=>[e,e.toLowerCase()==="authorization"||e.toLowerCase()==="cookie"||e.toLowerCase()==="set-cookie"?"***":t]))),"retryOfRequestLogID"in n&&(n.retryOfRequestLogID&&(n.retryOf=n.retryOfRequestLogID),delete n.retryOfRequestLogID),n);var ht;class fe{constructor(e,t,s){this.iterator=e,ht.set(this,void 0),this.controller=t,v(this,ht,s)}static fromSSEResponse(e,t,s){let r=!1;const a=s?H(s):console;async function*i(){if(r)throw new k("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let o=!1;try{for await(const c of Tc(e,t))if(!o){if(c.data.startsWith("[DONE]")){o=!0;continue}if(c.event===null||!c.event.startsWith("thread.")){let h;try{h=JSON.parse(c.data)}catch(m){throw a.error("Could not parse message into JSON:",c.data),a.error("From chunk:",c.raw),m}if(h&&h.error)throw new K(void 0,h.error,void 0,e.headers);yield h}else{let h;try{h=JSON.parse(c.data)}catch(m){throw console.error("Could not parse message into JSON:",c.data),console.error("From chunk:",c.raw),m}if(c.event=="error")throw new K(void 0,h.error,h.message,void 0);yield{event:c.event,data:h}}}o=!0}catch(c){if(_n(c))return;throw c}finally{o||t.abort()}}return new fe(i,t,s)}static fromReadableStream(e,t,s){let r=!1;async function*a(){const o=new Os,c=ti(e);for await(const h of c)for(const m of o.decode(h))yield m;for(const h of o.flush())yield h}async function*i(){if(r)throw new k("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let o=!1;try{for await(const c of a())o||c&&(yield JSON.parse(c));o=!0}catch(c){if(_n(c))return;throw c}finally{o||t.abort()}}return new fe(i,t,s)}[(ht=new WeakMap,Symbol.asyncIterator)](){return this.iterator()}tee(){const e=[],t=[],s=this.iterator(),r=a=>({next:()=>{if(a.length===0){const i=s.next();e.push(i),t.push(i)}return a.shift()}});return[new fe(()=>r(e),this.controller,l(this,ht,"f")),new fe(()=>r(t),this.controller,l(this,ht,"f"))]}toReadableStream(){const e=this;let t;return Za({async start(){t=e[Symbol.asyncIterator]()},async pull(s){try{const{value:r,done:a}=await t.next();if(a)return s.close();const i=Fn(JSON.stringify(r)+`
`);s.enqueue(i)}catch(r){s.error(r)}},async cancel(){var s;await((s=t.return)==null?void 0:s.call(t))}})}}async function*Tc(n,e){if(!n.body)throw e.abort(),typeof globalThis.navigator<"u"&&globalThis.navigator.product==="ReactNative"?new k("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api"):new k("Attempted to iterate over a response with no body");const t=new Bc,s=new Os,r=ti(n.body);for await(const a of Nc(r))for(const i of s.decode(a)){const o=t.decode(i);o&&(yield o)}for(const a of s.flush()){const i=t.decode(a);i&&(yield i)}}async function*Nc(n){let e=new Uint8Array;for await(const t of n){if(t==null)continue;const s=t instanceof ArrayBuffer?new Uint8Array(t):typeof t=="string"?Fn(t):t;let r=new Uint8Array(e.length+s.length);r.set(e),r.set(s,e.length),e=r;let a;for(;(a=Cc(e))!==-1;)yield e.slice(0,a),e=e.slice(a)}e.length>0&&(yield e)}class Bc{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const a={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],a}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,s,r]=Lc(e,":");return r.startsWith(" ")&&(r=r.substring(1)),t==="event"?this.event=r:t==="data"&&this.data.push(r),null}}function Lc(n,e){const t=n.indexOf(e);return t!==-1?[n.substring(0,t),e,n.substring(t+e.length)]:[n,"",""]}async function oi(n,e){const{response:t,requestLogID:s,retryOfRequestLogID:r,startTime:a}=e,i=await(async()=>{var f;if(e.options.stream)return H(n).debug("response",t.status,t.url,t.headers,t.body),e.options.__streamClass?e.options.__streamClass.fromSSEResponse(t,e.controller,n):fe.fromSSEResponse(t,e.controller,n);if(t.status===204)return null;if(e.options.__binaryResponse)return t;const o=t.headers.get("content-type"),c=(f=o==null?void 0:o.split(";")[0])==null?void 0:f.trim();if((c==null?void 0:c.includes("application/json"))||(c==null?void 0:c.endsWith("+json"))){const p=await t.json();return ci(p,t)}return await t.text()})();return H(n).debug(`[${s}] response parsed`,Ee({retryOfRequestLogID:r,url:t.url,status:t.status,body:i,durationMs:Date.now()-a})),i}function ci(n,e){return!n||typeof n!="object"||Array.isArray(n)?n:Object.defineProperty(n,"_request_id",{value:e.headers.get("x-request-id"),enumerable:!1})}var _t;class Ts extends Promise{constructor(e,t,s=oi){super(r=>{r(null)}),this.responsePromise=t,this.parseResponse=s,_t.set(this,void 0),v(this,_t,e)}_thenUnwrap(e){return new Ts(l(this,_t,"f"),this.responsePromise,async(t,s)=>ci(e(await this.parseResponse(t,s),s),s.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(e=>this.parseResponse(l(this,_t,"f"),e))),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}_t=new WeakMap;var Zt;class jn{constructor(e,t,s,r){Zt.set(this,void 0),v(this,Zt,e),this.options=r,this.response=t,this.body=s}hasNextPage(){return this.getPaginatedItems().length?this.nextPageRequestOptions()!=null:!1}async getNextPage(){const e=this.nextPageRequestOptions();if(!e)throw new k("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");return await l(this,Zt,"f").requestAPIList(this.constructor,e)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(Zt=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const t of e.getPaginatedItems())yield t}}class Fc extends Ts{constructor(e,t,s){super(e,t,async(r,a)=>new s(r,a.response,await oi(r,a),a.options))}async*[Symbol.asyncIterator](){const e=await this;for await(const t of e)yield t}}class Ns extends jn{constructor(e,t,s,r){super(e,t,s,r),this.data=s.data||[],this.object=s.object}getPaginatedItems(){return this.data??[]}nextPageRequestOptions(){return null}}class F extends jn{constructor(e,t,s,r){super(e,t,s,r),this.data=s.data||[],this.has_more=s.has_more||!1}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageRequestOptions(){var s;const e=this.getPaginatedItems(),t=(s=e[e.length-1])==null?void 0:s.id;return t?{...this.options,query:{...Ya(this.options.query),after:t}}:null}}class bs extends jn{constructor(e,t,s,r){super(e,t,s,r),this.data=s.data||[],this.has_more=s.has_more||!1,this.last_id=s.last_id||""}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageRequestOptions(){const e=this.last_id;return e?{...this.options,query:{...Ya(this.options.query),after:e}}:null}}const li=()=>{var n;if(typeof File>"u"){const{process:e}=globalThis,t=typeof((n=e==null?void 0:e.versions)==null?void 0:n.node)=="string"&&parseInt(e.versions.node.split("."))<20;throw new Error("`File` is not defined as a global, which is required for file uploads."+(t?" Update to Node 20 LTS or newer, or set `globalThis.File` to `import('node:buffer').File`.":""))}};function $t(n,e,t){return li(),new File(n,e??"unknown_file",t)}function os(n){return(typeof n=="object"&&n!==null&&("name"in n&&n.name&&String(n.name)||"url"in n&&n.url&&String(n.url)||"filename"in n&&n.filename&&String(n.filename)||"path"in n&&n.path&&String(n.path))||"").split(/[\\/]/).pop()||void 0}const qn=n=>n!=null&&typeof n=="object"&&typeof n[Symbol.asyncIterator]=="function",Dr=async(n,e)=>bn(n.body)?{...n,body:await ui(n.body,e)}:n,Oe=async(n,e)=>({...n,body:await ui(n.body,e)}),Hr=new WeakMap;function jc(n){const e=typeof n=="function"?n:n.fetch,t=Hr.get(e);if(t)return t;const s=(async()=>{try{const r="Response"in e?e.Response:(await e("data:,")).constructor,a=new FormData;return a.toString()!==await new r(a).text()}catch{return!0}})();return Hr.set(e,s),s}const ui=async(n,e)=>{if(!await jc(e))throw new TypeError("The provided fetch function does not support file uploads with the current global FormData class.");const t=new FormData;return await Promise.all(Object.entries(n||{}).map(([s,r])=>Sn(t,s,r))),t},hi=n=>n instanceof Blob&&"name"in n,qc=n=>typeof n=="object"&&n!==null&&(n instanceof Response||qn(n)||hi(n)),bn=n=>{if(qc(n))return!0;if(Array.isArray(n))return n.some(bn);if(n&&typeof n=="object"){for(const e in n)if(bn(n[e]))return!0}return!1},Sn=async(n,e,t)=>{if(t!==void 0){if(t==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")n.append(e,String(t));else if(t instanceof Response)n.append(e,$t([await t.blob()],os(t)));else if(qn(t))n.append(e,$t([await new Response(ei(t)).blob()],os(t)));else if(hi(t))n.append(e,t,os(t));else if(Array.isArray(t))await Promise.all(t.map(s=>Sn(n,e+"[]",s)));else if(typeof t=="object")await Promise.all(Object.entries(t).map(([s,r])=>Sn(n,`${e}[${s}]`,r)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${t} instead`)}},di=n=>n!=null&&typeof n=="object"&&typeof n.size=="number"&&typeof n.type=="string"&&typeof n.text=="function"&&typeof n.slice=="function"&&typeof n.arrayBuffer=="function",Uc=n=>n!=null&&typeof n=="object"&&typeof n.name=="string"&&typeof n.lastModified=="number"&&di(n),Wc=n=>n!=null&&typeof n=="object"&&typeof n.url=="string"&&typeof n.blob=="function";async function Dc(n,e,t){if(li(),n=await n,Uc(n))return n instanceof File?n:$t([await n.arrayBuffer()],n.name);if(Wc(n)){const r=await n.blob();return e||(e=new URL(n.url).pathname.split(/[\\/]/).pop()),$t(await xn(r),e,t)}const s=await xn(n);if(e||(e=os(n)),!(t!=null&&t.type)){const r=s.find(a=>typeof a=="object"&&"type"in a&&a.type);typeof r=="string"&&(t={...t,type:r})}return $t(s,e,t)}async function xn(n){var t;let e=[];if(typeof n=="string"||ArrayBuffer.isView(n)||n instanceof ArrayBuffer)e.push(n);else if(di(n))e.push(n instanceof Blob?n:await n.arrayBuffer());else if(qn(n))for await(const s of n)e.push(...await xn(s));else{const s=(t=n==null?void 0:n.constructor)==null?void 0:t.name;throw new Error(`Unexpected data type: ${typeof n}${s?`; constructor: ${s}`:""}${Hc(n)}`)}return e}function Hc(n){return typeof n!="object"||n===null?"":`; props: [${Object.getOwnPropertyNames(n).map(t=>`"${t}"`).join(", ")}]`}class x{constructor(e){this._client=e}}function fi(n){return n.replace(/[^A-Za-z0-9\-._~!$&'()*+,;=:@]+/g,encodeURIComponent)}const Jr=Object.freeze(Object.create(null)),Jc=(n=fi)=>function(t,...s){if(t.length===1)return t[0];let r=!1;const a=[],i=t.reduce((m,f,p)=>{var b;/[?#]/.test(f)&&(r=!0);const d=s[p];let _=(r?encodeURIComponent:n)(""+d);return p!==s.length&&(d==null||typeof d=="object"&&d.toString===((b=Object.getPrototypeOf(Object.getPrototypeOf(d.hasOwnProperty??Jr)??Jr))==null?void 0:b.toString))&&(_=d+"",a.push({start:m.length+f.length,length:_.length,error:`Value of type ${Object.prototype.toString.call(d).slice(8,-1)} is not a valid path parameter`})),m+f+(p===s.length?"":_)},""),o=i.split(/[?#]/,1)[0],c=new RegExp("(?<=^|\\/)(?:\\.|%2e){1,2}(?=\\/|$)","gi");let h;for(;(h=c.exec(o))!==null;)a.push({start:h.index,length:h[0].length,error:`Value "${h[0]}" can't be safely passed as a path parameter`});if(a.sort((m,f)=>m.start-f.start),a.length>0){let m=0;const f=a.reduce((p,d)=>{const _=" ".repeat(d.start-m),b="^".repeat(d.length);return m=d.start+d.length,p+_+b},"");throw new k(`Path parameters result in path with invalid segments:
${a.map(p=>p.error).join(`
`)}
${i}
${f}`)}return i},g=Jc(fi);let mi=class extends x{list(e,t={},s){return this._client.getAPIList(g`/chat/completions/${e}/messages`,F,{query:t,...s})}};function Ss(n){return n!==void 0&&"function"in n&&n.function!==void 0}function Un(n){return(n==null?void 0:n.$brand)==="auto-parseable-response-format"}function Tt(n){return(n==null?void 0:n.$brand)==="auto-parseable-tool"}function Xc(n,e){return!e||!gi(e)?{...n,choices:n.choices.map(t=>(pi(t.message.tool_calls),{...t,message:{...t.message,parsed:null,...t.message.tool_calls?{tool_calls:t.message.tool_calls}:void 0}}))}:Wn(n,e)}function Wn(n,e){const t=n.choices.map(s=>{var r;if(s.finish_reason==="length")throw new Qa;if(s.finish_reason==="content_filter")throw new Ga;return pi(s.message.tool_calls),{...s,message:{...s.message,...s.message.tool_calls?{tool_calls:((r=s.message.tool_calls)==null?void 0:r.map(a=>Vc(e,a)))??void 0}:void 0,parsed:s.message.content&&!s.message.refusal?Kc(e,s.message.content):null}}});return{...n,choices:t}}function Kc(n,e){var t,s;return((t=n.response_format)==null?void 0:t.type)!=="json_schema"?null:((s=n.response_format)==null?void 0:s.type)==="json_schema"?"$parseRaw"in n.response_format?n.response_format.$parseRaw(e):JSON.parse(e):null}function Vc(n,e){var s;const t=(s=n.tools)==null?void 0:s.find(r=>{var a;return Ss(r)&&((a=r.function)==null?void 0:a.name)===e.function.name});return{...e,function:{...e.function,parsed_arguments:Tt(t)?t.$parseRaw(e.function.arguments):t!=null&&t.function.strict?JSON.parse(e.function.arguments):null}}}function zc(n,e){var s;if(!n||!("tools"in n)||!n.tools)return!1;const t=(s=n.tools)==null?void 0:s.find(r=>{var a;return Ss(r)&&((a=r.function)==null?void 0:a.name)===e.function.name});return Ss(t)&&(Tt(t)||(t==null?void 0:t.function.strict)||!1)}function gi(n){var e;return Un(n.response_format)?!0:((e=n.tools)==null?void 0:e.some(t=>Tt(t)||t.type==="function"&&t.function.strict===!0))??!1}function pi(n){for(const e of n||[])if(e.type!=="function")throw new k(`Currently only \`function\` tool calls are supported; Received \`${e.type}\``)}function Qc(n){for(const e of n??[]){if(e.type!=="function")throw new k(`Currently only \`function\` tool types support auto-parsing; Received \`${e.type}\``);if(e.function.strict!==!0)throw new k(`The \`${e.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}const xs=n=>(n==null?void 0:n.role)==="assistant",_i=n=>(n==null?void 0:n.role)==="tool";var kn,cs,ls,yt,wt,us,bt,_e,St,ks,$s,De,yi;class Dn{constructor(){kn.add(this),this.controller=new AbortController,cs.set(this,void 0),ls.set(this,()=>{}),yt.set(this,()=>{}),wt.set(this,void 0),us.set(this,()=>{}),bt.set(this,()=>{}),_e.set(this,{}),St.set(this,!1),ks.set(this,!1),$s.set(this,!1),De.set(this,!1),v(this,cs,new Promise((e,t)=>{v(this,ls,e,"f"),v(this,yt,t,"f")})),v(this,wt,new Promise((e,t)=>{v(this,us,e,"f"),v(this,bt,t,"f")})),l(this,cs,"f").catch(()=>{}),l(this,wt,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},l(this,kn,"m",yi).bind(this))},0)}_connected(){this.ended||(l(this,ls,"f").call(this),this._emit("connect"))}get ended(){return l(this,St,"f")}get errored(){return l(this,ks,"f")}get aborted(){return l(this,$s,"f")}abort(){this.controller.abort()}on(e,t){return(l(this,_e,"f")[e]||(l(this,_e,"f")[e]=[])).push({listener:t}),this}off(e,t){const s=l(this,_e,"f")[e];if(!s)return this;const r=s.findIndex(a=>a.listener===t);return r>=0&&s.splice(r,1),this}once(e,t){return(l(this,_e,"f")[e]||(l(this,_e,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,s)=>{v(this,De,!0),e!=="error"&&this.once("error",s),this.once(e,t)})}async done(){v(this,De,!0),await l(this,wt,"f")}_emit(e,...t){if(l(this,St,"f"))return;e==="end"&&(v(this,St,!0),l(this,us,"f").call(this));const s=l(this,_e,"f")[e];if(s&&(l(this,_e,"f")[e]=s.filter(r=>!r.once),s.forEach(({listener:r})=>r(...t))),e==="abort"){const r=t[0];!l(this,De,"f")&&!(s!=null&&s.length)&&Promise.reject(r),l(this,yt,"f").call(this,r),l(this,bt,"f").call(this,r),this._emit("end");return}if(e==="error"){const r=t[0];!l(this,De,"f")&&!(s!=null&&s.length)&&Promise.reject(r),l(this,yt,"f").call(this,r),l(this,bt,"f").call(this,r),this._emit("end")}}_emitFinal(){}}cs=new WeakMap,ls=new WeakMap,yt=new WeakMap,wt=new WeakMap,us=new WeakMap,bt=new WeakMap,_e=new WeakMap,St=new WeakMap,ks=new WeakMap,$s=new WeakMap,De=new WeakMap,kn=new WeakSet,yi=function(e){if(v(this,ks,!0),e instanceof Error&&e.name==="AbortError"&&(e=new oe),e instanceof oe)return v(this,$s,!0),this._emit("abort",e);if(e instanceof k)return this._emit("error",e);if(e instanceof Error){const t=new k(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new k(String(e)))};function Gc(n){return typeof n.parse=="function"}var V,$n,As,An,Rn,vn,wi,bi;const Yc=10;class Si extends Dn{constructor(){super(...arguments),V.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){var s;this._chatCompletions.push(e),this._emit("chatCompletion",e);const t=(s=e.choices[0])==null?void 0:s.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t){if(this._emit("message",e),_i(e)&&e.content)this._emit("functionToolCallResult",e.content);else if(xs(e)&&e.tool_calls)for(const s of e.tool_calls)s.type==="function"&&this._emit("functionToolCall",s.function)}}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new k("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),l(this,V,"m",$n).call(this)}async finalMessage(){return await this.done(),l(this,V,"m",As).call(this)}async finalFunctionToolCall(){return await this.done(),l(this,V,"m",An).call(this)}async finalFunctionToolCallResult(){return await this.done(),l(this,V,"m",Rn).call(this)}async totalUsage(){return await this.done(),l(this,V,"m",vn).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const t=l(this,V,"m",As).call(this);t&&this._emit("finalMessage",t);const s=l(this,V,"m",$n).call(this);s&&this._emit("finalContent",s);const r=l(this,V,"m",An).call(this);r&&this._emit("finalFunctionToolCall",r);const a=l(this,V,"m",Rn).call(this);a!=null&&this._emit("finalFunctionToolCallResult",a),this._chatCompletions.some(i=>i.usage)&&this._emit("totalUsage",l(this,V,"m",vn).call(this))}async _createChatCompletion(e,t,s){const r=s==null?void 0:s.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),l(this,V,"m",wi).call(this,t);const a=await e.chat.completions.create({...t,stream:!1},{...s,signal:this.controller.signal});return this._connected(),this._addChatCompletion(Wn(a,t))}async _runChatCompletion(e,t,s){for(const r of t.messages)this._addMessage(r,!1);return await this._createChatCompletion(e,t,s)}async _runTools(e,t,s){var d,_,b;const r="tool",{tool_choice:a="auto",stream:i,...o}=t,c=typeof a!="string"&&a.type==="function"&&((d=a==null?void 0:a.function)==null?void 0:d.name),{maxChatCompletions:h=Yc}=s||{},m=t.tools.map(A=>{if(Tt(A)){if(!A.$callback)throw new k("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:A.$callback,name:A.function.name,description:A.function.description||"",parameters:A.function.parameters,parse:A.$parseRaw,strict:!0}}}return A}),f={};for(const A of m)A.type==="function"&&(f[A.function.name||A.function.function.name]=A.function);const p="tools"in t?m.map(A=>A.type==="function"?{type:"function",function:{name:A.function.name||A.function.function.name,parameters:A.function.parameters,description:A.function.description,strict:A.function.strict}}:A):void 0;for(const A of t.messages)this._addMessage(A,!1);for(let A=0;A<h;++A){const $=(_=(await this._createChatCompletion(e,{...o,tool_choice:a,tools:p,messages:[...this.messages]},s)).choices[0])==null?void 0:_.message;if(!$)throw new k("missing message in ChatCompletion response");if(!((b=$.tool_calls)!=null&&b.length))return;for(const R of $.tool_calls){if(R.type!=="function")continue;const S=R.id,{name:N,arguments:O}=R.function,I=f[N];if(I){if(c&&c!==N){const T=`Invalid tool_call: ${JSON.stringify(N)}. ${JSON.stringify(c)} requested. Please try again`;this._addMessage({role:r,tool_call_id:S,content:T});continue}}else{const T=`Invalid tool_call: ${JSON.stringify(N)}. Available options are: ${Object.keys(f).map(Te=>JSON.stringify(Te)).join(", ")}. Please try again`;this._addMessage({role:r,tool_call_id:S,content:T});continue}let Q;try{Q=Gc(I)?await I.parse(O):O}catch(T){const Te=T instanceof Error?T.message:String(T);this._addMessage({role:r,tool_call_id:S,content:Te});continue}const C=await I.function(Q,this),B=l(this,V,"m",bi).call(this,C);if(this._addMessage({role:r,tool_call_id:S,content:B}),c)return}}}}V=new WeakSet,$n=function(){return l(this,V,"m",As).call(this).content??null},As=function(){let e=this.messages.length;for(;e-- >0;){const t=this.messages[e];if(xs(t))return{...t,content:t.content??null,refusal:t.refusal??null}}throw new k("stream ended without producing a ChatCompletionMessage with role=assistant")},An=function(){var e,t;for(let s=this.messages.length-1;s>=0;s--){const r=this.messages[s];if(xs(r)&&((e=r==null?void 0:r.tool_calls)!=null&&e.length))return(t=r.tool_calls.filter(a=>a.type==="function").at(-1))==null?void 0:t.function}},Rn=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(_i(t)&&t.content!=null&&typeof t.content=="string"&&this.messages.some(s=>{var r;return s.role==="assistant"&&((r=s.tool_calls)==null?void 0:r.some(a=>a.type==="function"&&a.id===t.tool_call_id))}))return t.content}},vn=function(){const e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},wi=function(e){if(e.n!=null&&e.n>1)throw new k("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},bi=function(e){return typeof e=="string"?e:e===void 0?"undefined":JSON.stringify(e)};class Hn extends Si{static runTools(e,t,s){const r=new Hn,a={...s,headers:{...s==null?void 0:s.headers,"X-Stainless-Helper-Method":"runTools"}};return r._run(()=>r._runTools(e,t,a)),r}_addMessage(e,t=!0){super._addMessage(e,t),xs(e)&&e.content&&this._emit("content",e.content)}}const xi=1,ki=2,$i=4,Ai=8,Ri=16,vi=32,Pi=64,Ei=128,Ii=256,Mi=Ei|Ii,Ci=Ri|vi|Mi|Pi,Oi=xi|ki|Ci,Ti=$i|Ai,Zc=Oi|Ti,D={STR:xi,NUM:ki,ARR:$i,OBJ:Ai,NULL:Ri,BOOL:vi,NAN:Pi,INFINITY:Ei,MINUS_INFINITY:Ii,INF:Mi,SPECIAL:Ci,ATOM:Oi,COLLECTION:Ti,ALL:Zc};class el extends Error{}class tl extends Error{}function sl(n,e=D.ALL){if(typeof n!="string")throw new TypeError(`expecting str, got ${typeof n}`);if(!n.trim())throw new Error(`${n} is empty`);return nl(n.trim(),e)}const nl=(n,e)=>{const t=n.length;let s=0;const r=p=>{throw new el(`${p} at position ${s}`)},a=p=>{throw new tl(`${p} at position ${s}`)},i=()=>(f(),s>=t&&r("Unexpected end of input"),n[s]==='"'?o():n[s]==="{"?c():n[s]==="["?h():n.substring(s,s+4)==="null"||D.NULL&e&&t-s<4&&"null".startsWith(n.substring(s))?(s+=4,null):n.substring(s,s+4)==="true"||D.BOOL&e&&t-s<4&&"true".startsWith(n.substring(s))?(s+=4,!0):n.substring(s,s+5)==="false"||D.BOOL&e&&t-s<5&&"false".startsWith(n.substring(s))?(s+=5,!1):n.substring(s,s+8)==="Infinity"||D.INFINITY&e&&t-s<8&&"Infinity".startsWith(n.substring(s))?(s+=8,1/0):n.substring(s,s+9)==="-Infinity"||D.MINUS_INFINITY&e&&1<t-s&&t-s<9&&"-Infinity".startsWith(n.substring(s))?(s+=9,-1/0):n.substring(s,s+3)==="NaN"||D.NAN&e&&t-s<3&&"NaN".startsWith(n.substring(s))?(s+=3,NaN):m()),o=()=>{const p=s;let d=!1;for(s++;s<t&&(n[s]!=='"'||d&&n[s-1]==="\\");)d=n[s]==="\\"?!d:!1,s++;if(n.charAt(s)=='"')try{return JSON.parse(n.substring(p,++s-Number(d)))}catch(_){a(String(_))}else if(D.STR&e)try{return JSON.parse(n.substring(p,s-Number(d))+'"')}catch{return JSON.parse(n.substring(p,n.lastIndexOf("\\"))+'"')}r("Unterminated string literal")},c=()=>{s++,f();const p={};try{for(;n[s]!=="}";){if(f(),s>=t&&D.OBJ&e)return p;const d=o();f(),s++;try{const _=i();Object.defineProperty(p,d,{value:_,writable:!0,enumerable:!0,configurable:!0})}catch(_){if(D.OBJ&e)return p;throw _}f(),n[s]===","&&s++}}catch{if(D.OBJ&e)return p;r("Expected '}' at end of object")}return s++,p},h=()=>{s++;const p=[];try{for(;n[s]!=="]";)p.push(i()),f(),n[s]===","&&s++}catch{if(D.ARR&e)return p;r("Expected ']' at end of array")}return s++,p},m=()=>{if(s===0){n==="-"&&D.NUM&e&&r("Not sure what '-' is");try{return JSON.parse(n)}catch(d){if(D.NUM&e)try{return n[n.length-1]==="."?JSON.parse(n.substring(0,n.lastIndexOf("."))):JSON.parse(n.substring(0,n.lastIndexOf("e")))}catch{}a(String(d))}}const p=s;for(n[s]==="-"&&s++;n[s]&&!",]}".includes(n[s]);)s++;s==t&&!(D.NUM&e)&&r("Unterminated number literal");try{return JSON.parse(n.substring(p,s))}catch{n.substring(p,s)==="-"&&D.NUM&e&&r("Not sure what '-' is");try{return JSON.parse(n.substring(p,n.lastIndexOf("e")))}catch(_){a(String(_))}}},f=()=>{for(;s<t&&` 
\r	`.includes(n[s]);)s++};return i()},Xr=n=>sl(n,D.ALL^D.NUM);var q,pe,Le,xe,sn,es,nn,rn,an,ts,on,Kr;class Et extends Si{constructor(e){super(),q.add(this),pe.set(this,void 0),Le.set(this,void 0),xe.set(this,void 0),v(this,pe,e),v(this,Le,[])}get currentChatCompletionSnapshot(){return l(this,xe,"f")}static fromReadableStream(e){const t=new Et(null);return t._run(()=>t._fromReadableStream(e)),t}static createChatCompletion(e,t,s){const r=new Et(t);return r._run(()=>r._runChatCompletion(e,{...t,stream:!0},{...s,headers:{...s==null?void 0:s.headers,"X-Stainless-Helper-Method":"stream"}})),r}async _createChatCompletion(e,t,s){var i;super._createChatCompletion;const r=s==null?void 0:s.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),l(this,q,"m",sn).call(this);const a=await e.chat.completions.create({...t,stream:!0},{...s,signal:this.controller.signal});this._connected();for await(const o of a)l(this,q,"m",nn).call(this,o);if((i=a.controller.signal)!=null&&i.aborted)throw new oe;return this._addChatCompletion(l(this,q,"m",ts).call(this))}async _fromReadableStream(e,t){var i;const s=t==null?void 0:t.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),l(this,q,"m",sn).call(this),this._connected();const r=fe.fromReadableStream(e,this.controller);let a;for await(const o of r)a&&a!==o.id&&this._addChatCompletion(l(this,q,"m",ts).call(this)),l(this,q,"m",nn).call(this,o),a=o.id;if((i=r.controller.signal)!=null&&i.aborted)throw new oe;return this._addChatCompletion(l(this,q,"m",ts).call(this))}[(pe=new WeakMap,Le=new WeakMap,xe=new WeakMap,q=new WeakSet,sn=function(){this.ended||v(this,xe,void 0)},es=function(t){let s=l(this,Le,"f")[t.index];return s||(s={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},l(this,Le,"f")[t.index]=s,s)},nn=function(t){var r,a,i,o,c,h,m,f,p,d,_,b,A,L,$;if(this.ended)return;const s=l(this,q,"m",Kr).call(this,t);this._emit("chunk",t,s);for(const R of t.choices){const S=s.choices[R.index];R.delta.content!=null&&((r=S.message)==null?void 0:r.role)==="assistant"&&((a=S.message)!=null&&a.content)&&(this._emit("content",R.delta.content,S.message.content),this._emit("content.delta",{delta:R.delta.content,snapshot:S.message.content,parsed:S.message.parsed})),R.delta.refusal!=null&&((i=S.message)==null?void 0:i.role)==="assistant"&&((o=S.message)!=null&&o.refusal)&&this._emit("refusal.delta",{delta:R.delta.refusal,snapshot:S.message.refusal}),((c=R.logprobs)==null?void 0:c.content)!=null&&((h=S.message)==null?void 0:h.role)==="assistant"&&this._emit("logprobs.content.delta",{content:(m=R.logprobs)==null?void 0:m.content,snapshot:((f=S.logprobs)==null?void 0:f.content)??[]}),((p=R.logprobs)==null?void 0:p.refusal)!=null&&((d=S.message)==null?void 0:d.role)==="assistant"&&this._emit("logprobs.refusal.delta",{refusal:(_=R.logprobs)==null?void 0:_.refusal,snapshot:((b=S.logprobs)==null?void 0:b.refusal)??[]});const N=l(this,q,"m",es).call(this,S);S.finish_reason&&(l(this,q,"m",an).call(this,S),N.current_tool_call_index!=null&&l(this,q,"m",rn).call(this,S,N.current_tool_call_index));for(const O of R.delta.tool_calls??[])N.current_tool_call_index!==O.index&&(l(this,q,"m",an).call(this,S),N.current_tool_call_index!=null&&l(this,q,"m",rn).call(this,S,N.current_tool_call_index)),N.current_tool_call_index=O.index;for(const O of R.delta.tool_calls??[]){const I=(A=S.message.tool_calls)==null?void 0:A[O.index];I!=null&&I.type&&((I==null?void 0:I.type)==="function"?this._emit("tool_calls.function.arguments.delta",{name:(L=I.function)==null?void 0:L.name,index:O.index,arguments:I.function.arguments,parsed_arguments:I.function.parsed_arguments,arguments_delta:(($=O.function)==null?void 0:$.arguments)??""}):(I==null||I.type,void 0))}}},rn=function(t,s){var i,o,c;if(l(this,q,"m",es).call(this,t).done_tool_calls.has(s))return;const a=(i=t.message.tool_calls)==null?void 0:i[s];if(!a)throw new Error("no tool call snapshot");if(!a.type)throw new Error("tool call snapshot missing `type`");if(a.type==="function"){const h=(c=(o=l(this,pe,"f"))==null?void 0:o.tools)==null?void 0:c.find(m=>Ss(m)&&m.function.name===a.function.name);this._emit("tool_calls.function.arguments.done",{name:a.function.name,index:s,arguments:a.function.arguments,parsed_arguments:Tt(h)?h.$parseRaw(a.function.arguments):h!=null&&h.function.strict?JSON.parse(a.function.arguments):null})}else a.type},an=function(t){var r,a;const s=l(this,q,"m",es).call(this,t);if(t.message.content&&!s.content_done){s.content_done=!0;const i=l(this,q,"m",on).call(this);this._emit("content.done",{content:t.message.content,parsed:i?i.$parseRaw(t.message.content):null})}t.message.refusal&&!s.refusal_done&&(s.refusal_done=!0,this._emit("refusal.done",{refusal:t.message.refusal})),(r=t.logprobs)!=null&&r.content&&!s.logprobs_content_done&&(s.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:t.logprobs.content})),(a=t.logprobs)!=null&&a.refusal&&!s.logprobs_refusal_done&&(s.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:t.logprobs.refusal}))},ts=function(){if(this.ended)throw new k("stream has ended, this shouldn't happen");const t=l(this,xe,"f");if(!t)throw new k("request ended without sending any chunks");return v(this,xe,void 0),v(this,Le,[]),rl(t,l(this,pe,"f"))},on=function(){var s;const t=(s=l(this,pe,"f"))==null?void 0:s.response_format;return Un(t)?t:null},Kr=function(t){var s,r,a,i;let o=l(this,xe,"f");const{choices:c,...h}=t;o?Object.assign(o,h):o=v(this,xe,{...h,choices:[]});for(const{delta:m,finish_reason:f,index:p,logprobs:d=null,..._}of t.choices){let b=o.choices[p];if(b||(b=o.choices[p]={finish_reason:f,index:p,message:{},logprobs:d,..._}),d)if(!b.logprobs)b.logprobs=Object.assign({},d);else{const{content:O,refusal:I,...Q}=d;Object.assign(b.logprobs,Q),O&&((s=b.logprobs).content??(s.content=[]),b.logprobs.content.push(...O)),I&&((r=b.logprobs).refusal??(r.refusal=[]),b.logprobs.refusal.push(...I))}if(f&&(b.finish_reason=f,l(this,pe,"f")&&gi(l(this,pe,"f")))){if(f==="length")throw new Qa;if(f==="content_filter")throw new Ga}if(Object.assign(b,_),!m)continue;const{content:A,refusal:L,function_call:$,role:R,tool_calls:S,...N}=m;if(Object.assign(b.message,N),L&&(b.message.refusal=(b.message.refusal||"")+L),R&&(b.message.role=R),$&&(b.message.function_call?($.name&&(b.message.function_call.name=$.name),$.arguments&&((a=b.message.function_call).arguments??(a.arguments=""),b.message.function_call.arguments+=$.arguments)):b.message.function_call=$),A&&(b.message.content=(b.message.content||"")+A,!b.message.refusal&&l(this,q,"m",on).call(this)&&(b.message.parsed=Xr(b.message.content))),S){b.message.tool_calls||(b.message.tool_calls=[]);for(const{index:O,id:I,type:Q,function:C,...B}of S){const T=(i=b.message.tool_calls)[O]??(i[O]={});Object.assign(T,B),I&&(T.id=I),Q&&(T.type=Q),C&&(T.function??(T.function={name:C.name??"",arguments:""})),C!=null&&C.name&&(T.function.name=C.name),C!=null&&C.arguments&&(T.function.arguments+=C.arguments,zc(l(this,pe,"f"),T)&&(T.function.parsed_arguments=Xr(T.function.arguments)))}}}return o},Symbol.asyncIterator)](){const e=[],t=[];let s=!1;return this.on("chunk",r=>{const a=t.shift();a?a.resolve(r):e.push(r)}),this.on("end",()=>{s=!0;for(const r of t)r.resolve(void 0);t.length=0}),this.on("abort",r=>{s=!0;for(const a of t)a.reject(r);t.length=0}),this.on("error",r=>{s=!0;for(const a of t)a.reject(r);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:s?{value:void 0,done:!0}:new Promise((a,i)=>t.push({resolve:a,reject:i})).then(a=>a?{value:a,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new fe(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function rl(n,e){const{id:t,choices:s,created:r,model:a,system_fingerprint:i,...o}=n,c={...o,id:t,choices:s.map(({message:h,finish_reason:m,index:f,logprobs:p,...d})=>{if(!m)throw new k(`missing finish_reason for choice ${f}`);const{content:_=null,function_call:b,tool_calls:A,...L}=h,$=h.role;if(!$)throw new k(`missing role for choice ${f}`);if(b){const{arguments:R,name:S}=b;if(R==null)throw new k(`missing function_call.arguments for choice ${f}`);if(!S)throw new k(`missing function_call.name for choice ${f}`);return{...d,message:{content:_,function_call:{arguments:R,name:S},role:$,refusal:h.refusal??null},finish_reason:m,index:f,logprobs:p}}return A?{...d,index:f,finish_reason:m,logprobs:p,message:{...L,role:$,content:_,refusal:h.refusal??null,tool_calls:A.map((R,S)=>{const{function:N,type:O,id:I,...Q}=R,{arguments:C,name:B,...T}=N||{};if(I==null)throw new k(`missing choices[${f}].tool_calls[${S}].id
${ss(n)}`);if(O==null)throw new k(`missing choices[${f}].tool_calls[${S}].type
${ss(n)}`);if(B==null)throw new k(`missing choices[${f}].tool_calls[${S}].function.name
${ss(n)}`);if(C==null)throw new k(`missing choices[${f}].tool_calls[${S}].function.arguments
${ss(n)}`);return{...Q,id:I,type:O,function:{...T,name:B,arguments:C}}})}}:{...d,message:{...L,content:_,role:$,refusal:h.refusal??null},finish_reason:m,index:f,logprobs:p}}),created:r,model:a,object:"chat.completion",...i?{system_fingerprint:i}:{}};return Xc(c,e)}function ss(n){return JSON.stringify(n)}class Rs extends Et{static fromReadableStream(e){const t=new Rs(null);return t._run(()=>t._fromReadableStream(e)),t}static runTools(e,t,s){const r=new Rs(t),a={...s,headers:{...s==null?void 0:s.headers,"X-Stainless-Helper-Method":"runTools"}};return r._run(()=>r._runTools(e,t,a)),r}}let Jn=class extends x{constructor(){super(...arguments),this.messages=new mi(this._client)}create(e,t){return this._client.post("/chat/completions",{body:e,...t,stream:e.stream??!1})}retrieve(e,t){return this._client.get(g`/chat/completions/${e}`,t)}update(e,t,s){return this._client.post(g`/chat/completions/${e}`,{body:t,...s})}list(e={},t){return this._client.getAPIList("/chat/completions",F,{query:e,...t})}delete(e,t){return this._client.delete(g`/chat/completions/${e}`,t)}parse(e,t){return Qc(e.tools),this._client.chat.completions.create(e,{...t,headers:{...t==null?void 0:t.headers,"X-Stainless-Helper-Method":"chat.completions.parse"}})._thenUnwrap(s=>Wn(s,e))}runTools(e,t){return e.stream?Rs.runTools(this._client,e,t):Hn.runTools(this._client,e,t)}stream(e,t){return Et.createChatCompletion(this._client,e,t)}};Jn.Messages=mi;class Xn extends x{constructor(){super(...arguments),this.completions=new Jn(this._client)}}Xn.Completions=Jn;const Ni=Symbol("brand.privateNullableHeaders");function*al(n){if(!n)return;if(Ni in n){const{values:s,nulls:r}=n;yield*s.entries();for(const a of r)yield[a,null];return}let e=!1,t;n instanceof Headers?t=n.entries():Mr(n)?t=n:(e=!0,t=Object.entries(n??{}));for(let s of t){const r=s[0];if(typeof r!="string")throw new TypeError("expected header name to be a string");const a=Mr(s[1])?s[1]:[s[1]];let i=!1;for(const o of a)o!==void 0&&(e&&!i&&(i=!0,yield[r,null]),yield[r,o])}}const w=n=>{const e=new Headers,t=new Set;for(const s of n){const r=new Set;for(const[a,i]of al(s)){const o=a.toLowerCase();r.has(o)||(e.delete(a),r.add(o)),i===null?(e.delete(a),t.add(o)):(e.append(a,i),t.delete(o))}}return{[Ni]:!0,values:e,nulls:t}};class Bi extends x{create(e,t){return this._client.post("/audio/speech",{body:e,...t,headers:w([{Accept:"application/octet-stream"},t==null?void 0:t.headers]),__binaryResponse:!0})}}class Li extends x{create(e,t){return this._client.post("/audio/transcriptions",Oe({body:e,...t,stream:e.stream??!1,__metadata:{model:e.model}},this._client))}}class Fi extends x{create(e,t){return this._client.post("/audio/translations",Oe({body:e,...t,__metadata:{model:e.model}},this._client))}}class Nt extends x{constructor(){super(...arguments),this.transcriptions=new Li(this._client),this.translations=new Fi(this._client),this.speech=new Bi(this._client)}}Nt.Transcriptions=Li;Nt.Translations=Fi;Nt.Speech=Bi;class ji extends x{create(e,t){return this._client.post("/batches",{body:e,...t})}retrieve(e,t){return this._client.get(g`/batches/${e}`,t)}list(e={},t){return this._client.getAPIList("/batches",F,{query:e,...t})}cancel(e,t){return this._client.post(g`/batches/${e}/cancel`,t)}}class qi extends x{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:w([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}retrieve(e,t){return this._client.get(g`/assistants/${e}`,{...t,headers:w([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}update(e,t,s){return this._client.post(g`/assistants/${e}`,{body:t,...s,headers:w([{"OpenAI-Beta":"assistants=v2"},s==null?void 0:s.headers])})}list(e={},t){return this._client.getAPIList("/assistants",F,{query:e,...t,headers:w([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}delete(e,t){return this._client.delete(g`/assistants/${e}`,{...t,headers:w([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}}let Ui=class extends x{create(e,t){return this._client.post("/realtime/sessions",{body:e,...t,headers:w([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}};class Wi extends x{create(e,t){return this._client.post("/realtime/transcription_sessions",{body:e,...t,headers:w([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}}let Bs=class extends x{constructor(){super(...arguments),this.sessions=new Ui(this._client),this.transcriptionSessions=new Wi(this._client)}};Bs.Sessions=Ui;Bs.TranscriptionSessions=Wi;class Di extends x{create(e,t){return this._client.post("/chatkit/sessions",{body:e,...t,headers:w([{"OpenAI-Beta":"chatkit_beta=v1"},t==null?void 0:t.headers])})}cancel(e,t){return this._client.post(g`/chatkit/sessions/${e}/cancel`,{...t,headers:w([{"OpenAI-Beta":"chatkit_beta=v1"},t==null?void 0:t.headers])})}}let Hi=class extends x{retrieve(e,t){return this._client.get(g`/chatkit/threads/${e}`,{...t,headers:w([{"OpenAI-Beta":"chatkit_beta=v1"},t==null?void 0:t.headers])})}list(e={},t){return this._client.getAPIList("/chatkit/threads",bs,{query:e,...t,headers:w([{"OpenAI-Beta":"chatkit_beta=v1"},t==null?void 0:t.headers])})}delete(e,t){return this._client.delete(g`/chatkit/threads/${e}`,{...t,headers:w([{"OpenAI-Beta":"chatkit_beta=v1"},t==null?void 0:t.headers])})}listItems(e,t={},s){return this._client.getAPIList(g`/chatkit/threads/${e}/items`,bs,{query:t,...s,headers:w([{"OpenAI-Beta":"chatkit_beta=v1"},s==null?void 0:s.headers])})}};class Ls extends x{constructor(){super(...arguments),this.sessions=new Di(this._client),this.threads=new Hi(this._client)}}Ls.Sessions=Di;Ls.Threads=Hi;class Ji extends x{create(e,t,s){return this._client.post(g`/threads/${e}/messages`,{body:t,...s,headers:w([{"OpenAI-Beta":"assistants=v2"},s==null?void 0:s.headers])})}retrieve(e,t,s){const{thread_id:r}=t;return this._client.get(g`/threads/${r}/messages/${e}`,{...s,headers:w([{"OpenAI-Beta":"assistants=v2"},s==null?void 0:s.headers])})}update(e,t,s){const{thread_id:r,...a}=t;return this._client.post(g`/threads/${r}/messages/${e}`,{body:a,...s,headers:w([{"OpenAI-Beta":"assistants=v2"},s==null?void 0:s.headers])})}list(e,t={},s){return this._client.getAPIList(g`/threads/${e}/messages`,F,{query:t,...s,headers:w([{"OpenAI-Beta":"assistants=v2"},s==null?void 0:s.headers])})}delete(e,t,s){const{thread_id:r}=t;return this._client.delete(g`/threads/${r}/messages/${e}`,{...s,headers:w([{"OpenAI-Beta":"assistants=v2"},s==null?void 0:s.headers])})}}class Xi extends x{retrieve(e,t,s){const{thread_id:r,run_id:a,...i}=t;return this._client.get(g`/threads/${r}/runs/${a}/steps/${e}`,{query:i,...s,headers:w([{"OpenAI-Beta":"assistants=v2"},s==null?void 0:s.headers])})}list(e,t,s){const{thread_id:r,...a}=t;return this._client.getAPIList(g`/threads/${r}/runs/${e}/steps`,F,{query:a,...s,headers:w([{"OpenAI-Beta":"assistants=v2"},s==null?void 0:s.headers])})}}const il=n=>{if(typeof Buffer<"u"){const e=Buffer.from(n,"base64");return Array.from(new Float32Array(e.buffer,e.byteOffset,e.length/Float32Array.BYTES_PER_ELEMENT))}else{const e=atob(n),t=e.length,s=new Uint8Array(t);for(let r=0;r<t;r++)s[r]=e.charCodeAt(r);return Array.from(new Float32Array(s.buffer))}};var cn={};const Fe=n=>{var e,t,s,r;if(typeof globalThis.process<"u")return((e=cn==null?void 0:cn[n])==null?void 0:e.trim())??void 0;if(typeof globalThis.Deno<"u")return(r=(s=(t=globalThis.Deno.env)==null?void 0:t.get)==null?void 0:s.call(t,n))==null?void 0:r.trim()};var J,Me,Pn,de,hs,ce,Ce,Je,Ie,vs,ne,ds,fs,At,xt,kt,Vr,zr,Qr,Gr,Yr,Zr,ea;class Rt extends Dn{constructor(){super(...arguments),J.add(this),Pn.set(this,[]),de.set(this,{}),hs.set(this,{}),ce.set(this,void 0),Ce.set(this,void 0),Je.set(this,void 0),Ie.set(this,void 0),vs.set(this,void 0),ne.set(this,void 0),ds.set(this,void 0),fs.set(this,void 0),At.set(this,void 0)}[(Pn=new WeakMap,de=new WeakMap,hs=new WeakMap,ce=new WeakMap,Ce=new WeakMap,Je=new WeakMap,Ie=new WeakMap,vs=new WeakMap,ne=new WeakMap,ds=new WeakMap,fs=new WeakMap,At=new WeakMap,J=new WeakSet,Symbol.asyncIterator)](){const e=[],t=[];let s=!1;return this.on("event",r=>{const a=t.shift();a?a.resolve(r):e.push(r)}),this.on("end",()=>{s=!0;for(const r of t)r.resolve(void 0);t.length=0}),this.on("abort",r=>{s=!0;for(const a of t)a.reject(r);t.length=0}),this.on("error",r=>{s=!0;for(const a of t)a.reject(r);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:s?{value:void 0,done:!0}:new Promise((a,i)=>t.push({resolve:a,reject:i})).then(a=>a?{value:a,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){const t=new Me;return t._run(()=>t._fromReadableStream(e)),t}async _fromReadableStream(e,t){var a;const s=t==null?void 0:t.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),this._connected();const r=fe.fromReadableStream(e,this.controller);for await(const i of r)l(this,J,"m",xt).call(this,i);if((a=r.controller.signal)!=null&&a.aborted)throw new oe;return this._addRun(l(this,J,"m",kt).call(this))}toReadableStream(){return new fe(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,s,r){const a=new Me;return a._run(()=>a._runToolAssistantStream(e,t,s,{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),a}async _createToolAssistantStream(e,t,s,r){var c;const a=r==null?void 0:r.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort()));const i={...s,stream:!0},o=await e.submitToolOutputs(t,i,{...r,signal:this.controller.signal});this._connected();for await(const h of o)l(this,J,"m",xt).call(this,h);if((c=o.controller.signal)!=null&&c.aborted)throw new oe;return this._addRun(l(this,J,"m",kt).call(this))}static createThreadAssistantStream(e,t,s){const r=new Me;return r._run(()=>r._threadAssistantStream(e,t,{...s,headers:{...s==null?void 0:s.headers,"X-Stainless-Helper-Method":"stream"}})),r}static createAssistantStream(e,t,s,r){const a=new Me;return a._run(()=>a._runAssistantStream(e,t,s,{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),a}currentEvent(){return l(this,ds,"f")}currentRun(){return l(this,fs,"f")}currentMessageSnapshot(){return l(this,ce,"f")}currentRunStepSnapshot(){return l(this,At,"f")}async finalRunSteps(){return await this.done(),Object.values(l(this,de,"f"))}async finalMessages(){return await this.done(),Object.values(l(this,hs,"f"))}async finalRun(){if(await this.done(),!l(this,Ce,"f"))throw Error("Final run was not received.");return l(this,Ce,"f")}async _createThreadAssistantStream(e,t,s){var o;const r=s==null?void 0:s.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort()));const a={...t,stream:!0},i=await e.createAndRun(a,{...s,signal:this.controller.signal});this._connected();for await(const c of i)l(this,J,"m",xt).call(this,c);if((o=i.controller.signal)!=null&&o.aborted)throw new oe;return this._addRun(l(this,J,"m",kt).call(this))}async _createAssistantStream(e,t,s,r){var c;const a=r==null?void 0:r.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort()));const i={...s,stream:!0},o=await e.create(t,i,{...r,signal:this.controller.signal});this._connected();for await(const h of o)l(this,J,"m",xt).call(this,h);if((c=o.controller.signal)!=null&&c.aborted)throw new oe;return this._addRun(l(this,J,"m",kt).call(this))}static accumulateDelta(e,t){for(const[s,r]of Object.entries(t)){if(!e.hasOwnProperty(s)){e[s]=r;continue}let a=e[s];if(a==null){e[s]=r;continue}if(s==="index"||s==="type"){e[s]=r;continue}if(typeof a=="string"&&typeof r=="string")a+=r;else if(typeof a=="number"&&typeof r=="number")a+=r;else if(Zs(a)&&Zs(r))a=this.accumulateDelta(a,r);else if(Array.isArray(a)&&Array.isArray(r)){if(a.every(i=>typeof i=="string"||typeof i=="number")){a.push(...r);continue}for(const i of r){if(!Zs(i))throw new Error(`Expected array delta entry to be an object but got: ${i}`);const o=i.index;if(o==null)throw console.error(i),new Error("Expected array delta entry to have an `index` property");if(typeof o!="number")throw new Error(`Expected array delta entry \`index\` property to be a number but got ${o}`);const c=a[o];c==null?a.push(i):a[o]=this.accumulateDelta(c,i)}continue}else throw Error(`Unhandled record type: ${s}, deltaValue: ${r}, accValue: ${a}`);e[s]=a}return e}_addRun(e){return e}async _threadAssistantStream(e,t,s){return await this._createThreadAssistantStream(t,e,s)}async _runAssistantStream(e,t,s,r){return await this._createAssistantStream(t,e,s,r)}async _runToolAssistantStream(e,t,s,r){return await this._createToolAssistantStream(t,e,s,r)}}Me=Rt,xt=function(e){if(!this.ended)switch(v(this,ds,e),l(this,J,"m",Qr).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.incomplete":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":l(this,J,"m",ea).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":l(this,J,"m",zr).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":l(this,J,"m",Vr).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},kt=function(){if(this.ended)throw new k("stream has ended, this shouldn't happen");if(!l(this,Ce,"f"))throw Error("Final run has not been received");return l(this,Ce,"f")},Vr=function(e){const[t,s]=l(this,J,"m",Yr).call(this,e,l(this,ce,"f"));v(this,ce,t),l(this,hs,"f")[t.id]=t;for(const r of s){const a=t.content[r.index];(a==null?void 0:a.type)=="text"&&this._emit("textCreated",a.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(const r of e.data.delta.content){if(r.type=="text"&&r.text){let a=r.text,i=t.content[r.index];if(i&&i.type=="text")this._emit("textDelta",a,i.text);else throw Error("The snapshot associated with this text delta is not text or missing")}if(r.index!=l(this,Je,"f")){if(l(this,Ie,"f"))switch(l(this,Ie,"f").type){case"text":this._emit("textDone",l(this,Ie,"f").text,l(this,ce,"f"));break;case"image_file":this._emit("imageFileDone",l(this,Ie,"f").image_file,l(this,ce,"f"));break}v(this,Je,r.index)}v(this,Ie,t.content[r.index])}break;case"thread.message.completed":case"thread.message.incomplete":if(l(this,Je,"f")!==void 0){const r=e.data.content[l(this,Je,"f")];if(r)switch(r.type){case"image_file":this._emit("imageFileDone",r.image_file,l(this,ce,"f"));break;case"text":this._emit("textDone",r.text,l(this,ce,"f"));break}}l(this,ce,"f")&&this._emit("messageDone",e.data),v(this,ce,void 0)}},zr=function(e){const t=l(this,J,"m",Gr).call(this,e);switch(v(this,At,t),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":const s=e.data.delta;if(s.step_details&&s.step_details.type=="tool_calls"&&s.step_details.tool_calls&&t.step_details.type=="tool_calls")for(const a of s.step_details.tool_calls)a.index==l(this,vs,"f")?this._emit("toolCallDelta",a,t.step_details.tool_calls[a.index]):(l(this,ne,"f")&&this._emit("toolCallDone",l(this,ne,"f")),v(this,vs,a.index),v(this,ne,t.step_details.tool_calls[a.index]),l(this,ne,"f")&&this._emit("toolCallCreated",l(this,ne,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":v(this,At,void 0),e.data.step_details.type=="tool_calls"&&l(this,ne,"f")&&(this._emit("toolCallDone",l(this,ne,"f")),v(this,ne,void 0)),this._emit("runStepDone",e.data,t);break}},Qr=function(e){l(this,Pn,"f").push(e),this._emit("event",e)},Gr=function(e){switch(e.event){case"thread.run.step.created":return l(this,de,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=l(this,de,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let s=e.data;if(s.delta){const r=Me.accumulateDelta(t,s.delta);l(this,de,"f")[e.data.id]=r}return l(this,de,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":l(this,de,"f")[e.data.id]=e.data;break}if(l(this,de,"f")[e.data.id])return l(this,de,"f")[e.data.id];throw new Error("No snapshot available")},Yr=function(e,t){let s=[];switch(e.event){case"thread.message.created":return[e.data,s];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let r=e.data;if(r.delta.content)for(const a of r.delta.content)if(a.index in t.content){let i=t.content[a.index];t.content[a.index]=l(this,J,"m",Zr).call(this,a,i)}else t.content[a.index]=a,s.push(a);return[t,s];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,s];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},Zr=function(e,t){return Me.accumulateDelta(t,e)},ea=function(e){switch(v(this,fs,e.data),e.event){case"thread.run.created":break;case"thread.run.queued":break;case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":case"thread.run.incomplete":v(this,Ce,e.data),l(this,ne,"f")&&(this._emit("toolCallDone",l(this,ne,"f")),v(this,ne,void 0));break}};let Kn=class extends x{constructor(){super(...arguments),this.steps=new Xi(this._client)}create(e,t,s){const{include:r,...a}=t;return this._client.post(g`/threads/${e}/runs`,{query:{include:r},body:a,...s,headers:w([{"OpenAI-Beta":"assistants=v2"},s==null?void 0:s.headers]),stream:t.stream??!1})}retrieve(e,t,s){const{thread_id:r}=t;return this._client.get(g`/threads/${r}/runs/${e}`,{...s,headers:w([{"OpenAI-Beta":"assistants=v2"},s==null?void 0:s.headers])})}update(e,t,s){const{thread_id:r,...a}=t;return this._client.post(g`/threads/${r}/runs/${e}`,{body:a,...s,headers:w([{"OpenAI-Beta":"assistants=v2"},s==null?void 0:s.headers])})}list(e,t={},s){return this._client.getAPIList(g`/threads/${e}/runs`,F,{query:t,...s,headers:w([{"OpenAI-Beta":"assistants=v2"},s==null?void 0:s.headers])})}cancel(e,t,s){const{thread_id:r}=t;return this._client.post(g`/threads/${r}/runs/${e}/cancel`,{...s,headers:w([{"OpenAI-Beta":"assistants=v2"},s==null?void 0:s.headers])})}async createAndPoll(e,t,s){const r=await this.create(e,t,s);return await this.poll(r.id,{thread_id:e},s)}createAndStream(e,t,s){return Rt.createAssistantStream(e,this._client.beta.threads.runs,t,s)}async poll(e,t,s){var a;const r=w([s==null?void 0:s.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":((a=s==null?void 0:s.pollIntervalMs)==null?void 0:a.toString())??void 0}]);for(;;){const{data:i,response:o}=await this.retrieve(e,t,{...s,headers:{...s==null?void 0:s.headers,...r}}).withResponse();switch(i.status){case"queued":case"in_progress":case"cancelling":let c=5e3;if(s!=null&&s.pollIntervalMs)c=s.pollIntervalMs;else{const h=o.headers.get("openai-poll-after-ms");if(h){const m=parseInt(h);isNaN(m)||(c=m)}}await Ot(c);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return i}}}stream(e,t,s){return Rt.createAssistantStream(e,this._client.beta.threads.runs,t,s)}submitToolOutputs(e,t,s){const{thread_id:r,...a}=t;return this._client.post(g`/threads/${r}/runs/${e}/submit_tool_outputs`,{body:a,...s,headers:w([{"OpenAI-Beta":"assistants=v2"},s==null?void 0:s.headers]),stream:t.stream??!1})}async submitToolOutputsAndPoll(e,t,s){const r=await this.submitToolOutputs(e,t,s);return await this.poll(r.id,t,s)}submitToolOutputsStream(e,t,s){return Rt.createToolAssistantStream(e,this._client.beta.threads.runs,t,s)}};Kn.Steps=Xi;class Fs extends x{constructor(){super(...arguments),this.runs=new Kn(this._client),this.messages=new Ji(this._client)}create(e={},t){return this._client.post("/threads",{body:e,...t,headers:w([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}retrieve(e,t){return this._client.get(g`/threads/${e}`,{...t,headers:w([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}update(e,t,s){return this._client.post(g`/threads/${e}`,{body:t,...s,headers:w([{"OpenAI-Beta":"assistants=v2"},s==null?void 0:s.headers])})}delete(e,t){return this._client.delete(g`/threads/${e}`,{...t,headers:w([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:w([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers]),stream:e.stream??!1})}async createAndRunPoll(e,t){const s=await this.createAndRun(e,t);return await this.runs.poll(s.id,{thread_id:s.thread_id},t)}createAndRunStream(e,t){return Rt.createThreadAssistantStream(e,this._client.beta.threads,t)}}Fs.Runs=Kn;Fs.Messages=Ji;class Ve extends x{constructor(){super(...arguments),this.realtime=new Bs(this._client),this.chatkit=new Ls(this._client),this.assistants=new qi(this._client),this.threads=new Fs(this._client)}}Ve.Realtime=Bs;Ve.ChatKit=Ls;Ve.Assistants=qi;Ve.Threads=Fs;class Ki extends x{create(e,t){return this._client.post("/completions",{body:e,...t,stream:e.stream??!1})}}class Vi extends x{retrieve(e,t,s){const{container_id:r}=t;return this._client.get(g`/containers/${r}/files/${e}/content`,{...s,headers:w([{Accept:"application/binary"},s==null?void 0:s.headers]),__binaryResponse:!0})}}let Vn=class extends x{constructor(){super(...arguments),this.content=new Vi(this._client)}create(e,t,s){return this._client.post(g`/containers/${e}/files`,Oe({body:t,...s},this._client))}retrieve(e,t,s){const{container_id:r}=t;return this._client.get(g`/containers/${r}/files/${e}`,s)}list(e,t={},s){return this._client.getAPIList(g`/containers/${e}/files`,F,{query:t,...s})}delete(e,t,s){const{container_id:r}=t;return this._client.delete(g`/containers/${r}/files/${e}`,{...s,headers:w([{Accept:"*/*"},s==null?void 0:s.headers])})}};Vn.Content=Vi;class zn extends x{constructor(){super(...arguments),this.files=new Vn(this._client)}create(e,t){return this._client.post("/containers",{body:e,...t})}retrieve(e,t){return this._client.get(g`/containers/${e}`,t)}list(e={},t){return this._client.getAPIList("/containers",F,{query:e,...t})}delete(e,t){return this._client.delete(g`/containers/${e}`,{...t,headers:w([{Accept:"*/*"},t==null?void 0:t.headers])})}}zn.Files=Vn;class zi extends x{create(e,t,s){const{include:r,...a}=t;return this._client.post(g`/conversations/${e}/items`,{query:{include:r},body:a,...s})}retrieve(e,t,s){const{conversation_id:r,...a}=t;return this._client.get(g`/conversations/${r}/items/${e}`,{query:a,...s})}list(e,t={},s){return this._client.getAPIList(g`/conversations/${e}/items`,bs,{query:t,...s})}delete(e,t,s){const{conversation_id:r}=t;return this._client.delete(g`/conversations/${r}/items/${e}`,s)}}class Qn extends x{constructor(){super(...arguments),this.items=new zi(this._client)}create(e={},t){return this._client.post("/conversations",{body:e,...t})}retrieve(e,t){return this._client.get(g`/conversations/${e}`,t)}update(e,t,s){return this._client.post(g`/conversations/${e}`,{body:t,...s})}delete(e,t){return this._client.delete(g`/conversations/${e}`,t)}}Qn.Items=zi;class Qi extends x{create(e,t){const s=!!e.encoding_format;let r=s?e.encoding_format:"base64";s&&H(this._client).debug("embeddings/user defined encoding_format:",e.encoding_format);const a=this._client.post("/embeddings",{body:{...e,encoding_format:r},...t});return s?a:(H(this._client).debug("embeddings/decoding base64 embeddings from base64"),a._thenUnwrap(i=>(i&&i.data&&i.data.forEach(o=>{const c=o.embedding;o.embedding=il(c)}),i)))}}class Gi extends x{retrieve(e,t,s){const{eval_id:r,run_id:a}=t;return this._client.get(g`/evals/${r}/runs/${a}/output_items/${e}`,s)}list(e,t,s){const{eval_id:r,...a}=t;return this._client.getAPIList(g`/evals/${r}/runs/${e}/output_items`,F,{query:a,...s})}}class Gn extends x{constructor(){super(...arguments),this.outputItems=new Gi(this._client)}create(e,t,s){return this._client.post(g`/evals/${e}/runs`,{body:t,...s})}retrieve(e,t,s){const{eval_id:r}=t;return this._client.get(g`/evals/${r}/runs/${e}`,s)}list(e,t={},s){return this._client.getAPIList(g`/evals/${e}/runs`,F,{query:t,...s})}delete(e,t,s){const{eval_id:r}=t;return this._client.delete(g`/evals/${r}/runs/${e}`,s)}cancel(e,t,s){const{eval_id:r}=t;return this._client.post(g`/evals/${r}/runs/${e}`,s)}}Gn.OutputItems=Gi;class Yn extends x{constructor(){super(...arguments),this.runs=new Gn(this._client)}create(e,t){return this._client.post("/evals",{body:e,...t})}retrieve(e,t){return this._client.get(g`/evals/${e}`,t)}update(e,t,s){return this._client.post(g`/evals/${e}`,{body:t,...s})}list(e={},t){return this._client.getAPIList("/evals",F,{query:e,...t})}delete(e,t){return this._client.delete(g`/evals/${e}`,t)}}Yn.Runs=Gn;let Yi=class extends x{create(e,t){return this._client.post("/files",Oe({body:e,...t},this._client))}retrieve(e,t){return this._client.get(g`/files/${e}`,t)}list(e={},t){return this._client.getAPIList("/files",F,{query:e,...t})}delete(e,t){return this._client.delete(g`/files/${e}`,t)}content(e,t){return this._client.get(g`/files/${e}/content`,{...t,headers:w([{Accept:"application/binary"},t==null?void 0:t.headers]),__binaryResponse:!0})}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:s=30*60*1e3}={}){const r=new Set(["processed","error","deleted"]),a=Date.now();let i=await this.retrieve(e);for(;!i.status||!r.has(i.status);)if(await Ot(t),i=await this.retrieve(e),Date.now()-a>s)throw new Ln({message:`Giving up on waiting for file ${e} to finish processing after ${s} milliseconds.`});return i}};class Zi extends x{}let eo=class extends x{run(e,t){return this._client.post("/fine_tuning/alpha/graders/run",{body:e,...t})}validate(e,t){return this._client.post("/fine_tuning/alpha/graders/validate",{body:e,...t})}};class Zn extends x{constructor(){super(...arguments),this.graders=new eo(this._client)}}Zn.Graders=eo;class to extends x{create(e,t,s){return this._client.getAPIList(g`/fine_tuning/checkpoints/${e}/permissions`,Ns,{body:t,method:"post",...s})}retrieve(e,t={},s){return this._client.get(g`/fine_tuning/checkpoints/${e}/permissions`,{query:t,...s})}delete(e,t,s){const{fine_tuned_model_checkpoint:r}=t;return this._client.delete(g`/fine_tuning/checkpoints/${r}/permissions/${e}`,s)}}let er=class extends x{constructor(){super(...arguments),this.permissions=new to(this._client)}};er.Permissions=to;class so extends x{list(e,t={},s){return this._client.getAPIList(g`/fine_tuning/jobs/${e}/checkpoints`,F,{query:t,...s})}}class tr extends x{constructor(){super(...arguments),this.checkpoints=new so(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(g`/fine_tuning/jobs/${e}`,t)}list(e={},t){return this._client.getAPIList("/fine_tuning/jobs",F,{query:e,...t})}cancel(e,t){return this._client.post(g`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},s){return this._client.getAPIList(g`/fine_tuning/jobs/${e}/events`,F,{query:t,...s})}pause(e,t){return this._client.post(g`/fine_tuning/jobs/${e}/pause`,t)}resume(e,t){return this._client.post(g`/fine_tuning/jobs/${e}/resume`,t)}}tr.Checkpoints=so;class ze extends x{constructor(){super(...arguments),this.methods=new Zi(this._client),this.jobs=new tr(this._client),this.checkpoints=new er(this._client),this.alpha=new Zn(this._client)}}ze.Methods=Zi;ze.Jobs=tr;ze.Checkpoints=er;ze.Alpha=Zn;class no extends x{}class sr extends x{constructor(){super(...arguments),this.graderModels=new no(this._client)}}sr.GraderModels=no;class ro extends x{createVariation(e,t){return this._client.post("/images/variations",Oe({body:e,...t},this._client))}edit(e,t){return this._client.post("/images/edits",Oe({body:e,...t,stream:e.stream??!1},this._client))}generate(e,t){return this._client.post("/images/generations",{body:e,...t,stream:e.stream??!1})}}class ao extends x{retrieve(e,t){return this._client.get(g`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",Ns,e)}delete(e,t){return this._client.delete(g`/models/${e}`,t)}}class io extends x{create(e,t){return this._client.post("/moderations",{body:e,...t})}}class oo extends x{accept(e,t,s){return this._client.post(g`/realtime/calls/${e}/accept`,{body:t,...s,headers:w([{Accept:"*/*"},s==null?void 0:s.headers])})}hangup(e,t){return this._client.post(g`/realtime/calls/${e}/hangup`,{...t,headers:w([{Accept:"*/*"},t==null?void 0:t.headers])})}refer(e,t,s){return this._client.post(g`/realtime/calls/${e}/refer`,{body:t,...s,headers:w([{Accept:"*/*"},s==null?void 0:s.headers])})}reject(e,t={},s){return this._client.post(g`/realtime/calls/${e}/reject`,{body:t,...s,headers:w([{Accept:"*/*"},s==null?void 0:s.headers])})}}class co extends x{create(e,t){return this._client.post("/realtime/client_secrets",{body:e,...t})}}class js extends x{constructor(){super(...arguments),this.clientSecrets=new co(this._client),this.calls=new oo(this._client)}}js.ClientSecrets=co;js.Calls=oo;function ol(n,e){return!e||!ll(e)?{...n,output_parsed:null,output:n.output.map(t=>t.type==="function_call"?{...t,parsed_arguments:null}:t.type==="message"?{...t,content:t.content.map(s=>({...s,parsed:null}))}:t)}:lo(n,e)}function lo(n,e){const t=n.output.map(r=>{if(r.type==="function_call")return{...r,parsed_arguments:dl(e,r)};if(r.type==="message"){const a=r.content.map(i=>i.type==="output_text"?{...i,parsed:cl(e,i.text)}:i);return{...r,content:a}}return r}),s=Object.assign({},n,{output:t});return Object.getOwnPropertyDescriptor(n,"output_text")||En(s),Object.defineProperty(s,"output_parsed",{enumerable:!0,get(){for(const r of s.output)if(r.type==="message"){for(const a of r.content)if(a.type==="output_text"&&a.parsed!==null)return a.parsed}return null}}),s}function cl(n,e){var t,s,r,a;return((s=(t=n.text)==null?void 0:t.format)==null?void 0:s.type)!=="json_schema"?null:"$parseRaw"in((r=n.text)==null?void 0:r.format)?((a=n.text)==null?void 0:a.format).$parseRaw(e):JSON.parse(e)}function ll(n){var e;return!!Un((e=n.text)==null?void 0:e.format)}function ul(n){return(n==null?void 0:n.$brand)==="auto-parseable-tool"}function hl(n,e){return n.find(t=>t.type==="function"&&t.name===e)}function dl(n,e){const t=hl(n.tools??[],e.name);return{...e,...e,parsed_arguments:ul(t)?t.$parseRaw(e.arguments):t!=null&&t.strict?JSON.parse(e.arguments):null}}function En(n){const e=[];for(const t of n.output)if(t.type==="message")for(const s of t.content)s.type==="output_text"&&e.push(s.text);n.output_text=e.join("")}var je,ns,ke,rs,ta,sa,na,ra;class nr extends Dn{constructor(e){super(),je.add(this),ns.set(this,void 0),ke.set(this,void 0),rs.set(this,void 0),v(this,ns,e)}static createResponse(e,t,s){const r=new nr(t);return r._run(()=>r._createOrRetrieveResponse(e,t,{...s,headers:{...s==null?void 0:s.headers,"X-Stainless-Helper-Method":"stream"}})),r}async _createOrRetrieveResponse(e,t,s){var o;const r=s==null?void 0:s.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),l(this,je,"m",ta).call(this);let a,i=null;"response_id"in t?(a=await e.responses.retrieve(t.response_id,{stream:!0},{...s,signal:this.controller.signal,stream:!0}),i=t.starting_after??null):a=await e.responses.create({...t,stream:!0},{...s,signal:this.controller.signal}),this._connected();for await(const c of a)l(this,je,"m",sa).call(this,c,i);if((o=a.controller.signal)!=null&&o.aborted)throw new oe;return l(this,je,"m",na).call(this)}[(ns=new WeakMap,ke=new WeakMap,rs=new WeakMap,je=new WeakSet,ta=function(){this.ended||v(this,ke,void 0)},sa=function(t,s){if(this.ended)return;const r=(i,o)=>{(s==null||o.sequence_number>s)&&this._emit(i,o)},a=l(this,je,"m",ra).call(this,t);switch(r("event",t),t.type){case"response.output_text.delta":{const i=a.output[t.output_index];if(!i)throw new k(`missing output at index ${t.output_index}`);if(i.type==="message"){const o=i.content[t.content_index];if(!o)throw new k(`missing content at index ${t.content_index}`);if(o.type!=="output_text")throw new k(`expected content to be 'output_text', got ${o.type}`);r("response.output_text.delta",{...t,snapshot:o.text})}break}case"response.function_call_arguments.delta":{const i=a.output[t.output_index];if(!i)throw new k(`missing output at index ${t.output_index}`);i.type==="function_call"&&r("response.function_call_arguments.delta",{...t,snapshot:i.arguments});break}default:r(t.type,t);break}},na=function(){if(this.ended)throw new k("stream has ended, this shouldn't happen");const t=l(this,ke,"f");if(!t)throw new k("request ended without sending any events");v(this,ke,void 0);const s=fl(t,l(this,ns,"f"));return v(this,rs,s),s},ra=function(t){var r;let s=l(this,ke,"f");if(!s){if(t.type!=="response.created")throw new k(`When snapshot hasn't been set yet, expected 'response.created' event, got ${t.type}`);return s=v(this,ke,t.response),s}switch(t.type){case"response.output_item.added":{s.output.push(t.item);break}case"response.content_part.added":{const a=s.output[t.output_index];if(!a)throw new k(`missing output at index ${t.output_index}`);const i=a.type,o=t.part;i==="message"&&o.type!=="reasoning_text"?a.content.push(o):i==="reasoning"&&o.type==="reasoning_text"&&(a.content||(a.content=[]),a.content.push(o));break}case"response.output_text.delta":{const a=s.output[t.output_index];if(!a)throw new k(`missing output at index ${t.output_index}`);if(a.type==="message"){const i=a.content[t.content_index];if(!i)throw new k(`missing content at index ${t.content_index}`);if(i.type!=="output_text")throw new k(`expected content to be 'output_text', got ${i.type}`);i.text+=t.delta}break}case"response.function_call_arguments.delta":{const a=s.output[t.output_index];if(!a)throw new k(`missing output at index ${t.output_index}`);a.type==="function_call"&&(a.arguments+=t.delta);break}case"response.reasoning_text.delta":{const a=s.output[t.output_index];if(!a)throw new k(`missing output at index ${t.output_index}`);if(a.type==="reasoning"){const i=(r=a.content)==null?void 0:r[t.content_index];if(!i)throw new k(`missing content at index ${t.content_index}`);if(i.type!=="reasoning_text")throw new k(`expected content to be 'reasoning_text', got ${i.type}`);i.text+=t.delta}break}case"response.completed":{v(this,ke,t.response);break}}return s},Symbol.asyncIterator)](){const e=[],t=[];let s=!1;return this.on("event",r=>{const a=t.shift();a?a.resolve(r):e.push(r)}),this.on("end",()=>{s=!0;for(const r of t)r.resolve(void 0);t.length=0}),this.on("abort",r=>{s=!0;for(const a of t)a.reject(r);t.length=0}),this.on("error",r=>{s=!0;for(const a of t)a.reject(r);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:s?{value:void 0,done:!0}:new Promise((a,i)=>t.push({resolve:a,reject:i})).then(a=>a?{value:a,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}async finalResponse(){await this.done();const e=l(this,rs,"f");if(!e)throw new k("stream ended without producing a ChatCompletion");return e}}function fl(n,e){return ol(n,e)}class uo extends x{list(e,t={},s){return this._client.getAPIList(g`/responses/${e}/input_items`,F,{query:t,...s})}}class ho extends x{count(e={},t){return this._client.post("/responses/input_tokens",{body:e,...t})}}class qs extends x{constructor(){super(...arguments),this.inputItems=new uo(this._client),this.inputTokens=new ho(this._client)}create(e,t){return this._client.post("/responses",{body:e,...t,stream:e.stream??!1})._thenUnwrap(s=>("object"in s&&s.object==="response"&&En(s),s))}retrieve(e,t={},s){return this._client.get(g`/responses/${e}`,{query:t,...s,stream:(t==null?void 0:t.stream)??!1})._thenUnwrap(r=>("object"in r&&r.object==="response"&&En(r),r))}delete(e,t){return this._client.delete(g`/responses/${e}`,{...t,headers:w([{Accept:"*/*"},t==null?void 0:t.headers])})}parse(e,t){return this._client.responses.create(e,t)._thenUnwrap(s=>lo(s,e))}stream(e,t){return nr.createResponse(this._client,e,t)}cancel(e,t){return this._client.post(g`/responses/${e}/cancel`,t)}compact(e,t){return this._client.post("/responses/compact",{body:e,...t})}}qs.InputItems=uo;qs.InputTokens=ho;class fo extends x{create(e,t,s){return this._client.post(g`/uploads/${e}/parts`,Oe({body:t,...s},this._client))}}class rr extends x{constructor(){super(...arguments),this.parts=new fo(this._client)}create(e,t){return this._client.post("/uploads",{body:e,...t})}cancel(e,t){return this._client.post(g`/uploads/${e}/cancel`,t)}complete(e,t,s){return this._client.post(g`/uploads/${e}/complete`,{body:t,...s})}}rr.Parts=fo;const ml=async n=>{const e=await Promise.allSettled(n),t=e.filter(r=>r.status==="rejected");if(t.length){for(const r of t)console.error(r.reason);throw new Error(`${t.length} promise(s) failed - see the above errors`)}const s=[];for(const r of e)r.status==="fulfilled"&&s.push(r.value);return s};class mo extends x{create(e,t,s){return this._client.post(g`/vector_stores/${e}/file_batches`,{body:t,...s,headers:w([{"OpenAI-Beta":"assistants=v2"},s==null?void 0:s.headers])})}retrieve(e,t,s){const{vector_store_id:r}=t;return this._client.get(g`/vector_stores/${r}/file_batches/${e}`,{...s,headers:w([{"OpenAI-Beta":"assistants=v2"},s==null?void 0:s.headers])})}cancel(e,t,s){const{vector_store_id:r}=t;return this._client.post(g`/vector_stores/${r}/file_batches/${e}/cancel`,{...s,headers:w([{"OpenAI-Beta":"assistants=v2"},s==null?void 0:s.headers])})}async createAndPoll(e,t,s){const r=await this.create(e,t);return await this.poll(e,r.id,s)}listFiles(e,t,s){const{vector_store_id:r,...a}=t;return this._client.getAPIList(g`/vector_stores/${r}/file_batches/${e}/files`,F,{query:a,...s,headers:w([{"OpenAI-Beta":"assistants=v2"},s==null?void 0:s.headers])})}async poll(e,t,s){var a;const r=w([s==null?void 0:s.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":((a=s==null?void 0:s.pollIntervalMs)==null?void 0:a.toString())??void 0}]);for(;;){const{data:i,response:o}=await this.retrieve(t,{vector_store_id:e},{...s,headers:r}).withResponse();switch(i.status){case"in_progress":let c=5e3;if(s!=null&&s.pollIntervalMs)c=s.pollIntervalMs;else{const h=o.headers.get("openai-poll-after-ms");if(h){const m=parseInt(h);isNaN(m)||(c=m)}}await Ot(c);break;case"failed":case"cancelled":case"completed":return i}}}async uploadAndPoll(e,{files:t,fileIds:s=[]},r){if(t==null||t.length==0)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");const a=(r==null?void 0:r.maxConcurrency)??5,i=Math.min(a,t.length),o=this._client,c=t.values(),h=[...s];async function m(p){for(let d of p){const _=await o.files.create({file:d,purpose:"assistants"},r);h.push(_.id)}}const f=Array(i).fill(c).map(m);return await ml(f),await this.createAndPoll(e,{file_ids:h})}}class go extends x{create(e,t,s){return this._client.post(g`/vector_stores/${e}/files`,{body:t,...s,headers:w([{"OpenAI-Beta":"assistants=v2"},s==null?void 0:s.headers])})}retrieve(e,t,s){const{vector_store_id:r}=t;return this._client.get(g`/vector_stores/${r}/files/${e}`,{...s,headers:w([{"OpenAI-Beta":"assistants=v2"},s==null?void 0:s.headers])})}update(e,t,s){const{vector_store_id:r,...a}=t;return this._client.post(g`/vector_stores/${r}/files/${e}`,{body:a,...s,headers:w([{"OpenAI-Beta":"assistants=v2"},s==null?void 0:s.headers])})}list(e,t={},s){return this._client.getAPIList(g`/vector_stores/${e}/files`,F,{query:t,...s,headers:w([{"OpenAI-Beta":"assistants=v2"},s==null?void 0:s.headers])})}delete(e,t,s){const{vector_store_id:r}=t;return this._client.delete(g`/vector_stores/${r}/files/${e}`,{...s,headers:w([{"OpenAI-Beta":"assistants=v2"},s==null?void 0:s.headers])})}async createAndPoll(e,t,s){const r=await this.create(e,t,s);return await this.poll(e,r.id,s)}async poll(e,t,s){var a;const r=w([s==null?void 0:s.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":((a=s==null?void 0:s.pollIntervalMs)==null?void 0:a.toString())??void 0}]);for(;;){const i=await this.retrieve(t,{vector_store_id:e},{...s,headers:r}).withResponse(),o=i.data;switch(o.status){case"in_progress":let c=5e3;if(s!=null&&s.pollIntervalMs)c=s.pollIntervalMs;else{const h=i.response.headers.get("openai-poll-after-ms");if(h){const m=parseInt(h);isNaN(m)||(c=m)}}await Ot(c);break;case"failed":case"completed":return o}}}async upload(e,t,s){const r=await this._client.files.create({file:t,purpose:"assistants"},s);return this.create(e,{file_id:r.id},s)}async uploadAndPoll(e,t,s){const r=await this.upload(e,t,s);return await this.poll(e,r.id,s)}content(e,t,s){const{vector_store_id:r}=t;return this._client.getAPIList(g`/vector_stores/${r}/files/${e}/content`,Ns,{...s,headers:w([{"OpenAI-Beta":"assistants=v2"},s==null?void 0:s.headers])})}}class Us extends x{constructor(){super(...arguments),this.files=new go(this._client),this.fileBatches=new mo(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:w([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}retrieve(e,t){return this._client.get(g`/vector_stores/${e}`,{...t,headers:w([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}update(e,t,s){return this._client.post(g`/vector_stores/${e}`,{body:t,...s,headers:w([{"OpenAI-Beta":"assistants=v2"},s==null?void 0:s.headers])})}list(e={},t){return this._client.getAPIList("/vector_stores",F,{query:e,...t,headers:w([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}delete(e,t){return this._client.delete(g`/vector_stores/${e}`,{...t,headers:w([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}search(e,t,s){return this._client.getAPIList(g`/vector_stores/${e}/search`,Ns,{body:t,method:"post",...s,headers:w([{"OpenAI-Beta":"assistants=v2"},s==null?void 0:s.headers])})}}Us.Files=go;Us.FileBatches=mo;class po extends x{create(e,t){return this._client.post("/videos",Dr({body:e,...t},this._client))}retrieve(e,t){return this._client.get(g`/videos/${e}`,t)}list(e={},t){return this._client.getAPIList("/videos",bs,{query:e,...t})}delete(e,t){return this._client.delete(g`/videos/${e}`,t)}downloadContent(e,t={},s){return this._client.get(g`/videos/${e}/content`,{query:t,...s,headers:w([{Accept:"application/binary"},s==null?void 0:s.headers]),__binaryResponse:!0})}remix(e,t,s){return this._client.post(g`/videos/${e}/remix`,Dr({body:t,...s},this._client))}}var He,_o,ms;class yo extends x{constructor(){super(...arguments),He.add(this)}async unwrap(e,t,s=this._client.webhookSecret,r=300){return await this.verifySignature(e,t,s,r),JSON.parse(e)}async verifySignature(e,t,s=this._client.webhookSecret,r=300){if(typeof crypto>"u"||typeof crypto.subtle.importKey!="function"||typeof crypto.subtle.verify!="function")throw new Error("Webhook signature verification is only supported when the `crypto` global is defined");l(this,He,"m",_o).call(this,s);const a=w([t]).values,i=l(this,He,"m",ms).call(this,a,"webhook-signature"),o=l(this,He,"m",ms).call(this,a,"webhook-timestamp"),c=l(this,He,"m",ms).call(this,a,"webhook-id"),h=parseInt(o,10);if(isNaN(h))throw new gt("Invalid webhook timestamp format");const m=Math.floor(Date.now()/1e3);if(m-h>r)throw new gt("Webhook timestamp is too old");if(h>m+r)throw new gt("Webhook timestamp is too new");const f=i.split(" ").map(b=>b.startsWith("v1,")?b.substring(3):b),p=s.startsWith("whsec_")?Buffer.from(s.replace("whsec_",""),"base64"):Buffer.from(s,"utf-8"),d=c?`${c}.${o}.${e}`:`${o}.${e}`,_=await crypto.subtle.importKey("raw",p,{name:"HMAC",hash:"SHA-256"},!1,["verify"]);for(const b of f)try{const A=Buffer.from(b,"base64");if(await crypto.subtle.verify("HMAC",_,A,new TextEncoder().encode(d)))return}catch{continue}throw new gt("The given webhook signature does not match the expected signature")}}He=new WeakSet,_o=function(e){if(typeof e!="string"||e.length===0)throw new Error("The webhook secret must either be set using the env var, OPENAI_WEBHOOK_SECRET, on the client class, OpenAI({ webhookSecret: '123' }), or passed to this function")},ms=function(e,t){if(!e)throw new Error("Headers are required");const s=e.get(t);if(s==null)throw new Error(`Missing required header: ${t}`);return s};var In,ar,gs,wo;class E{constructor({baseURL:e=Fe("OPENAI_BASE_URL"),apiKey:t=Fe("OPENAI_API_KEY"),organization:s=Fe("OPENAI_ORG_ID")??null,project:r=Fe("OPENAI_PROJECT_ID")??null,webhookSecret:a=Fe("OPENAI_WEBHOOK_SECRET")??null,...i}={}){if(In.add(this),gs.set(this,void 0),this.completions=new Ki(this),this.chat=new Xn(this),this.embeddings=new Qi(this),this.files=new Yi(this),this.images=new ro(this),this.audio=new Nt(this),this.moderations=new io(this),this.models=new ao(this),this.fineTuning=new ze(this),this.graders=new sr(this),this.vectorStores=new Us(this),this.webhooks=new yo(this),this.beta=new Ve(this),this.batches=new ji(this),this.uploads=new rr(this),this.responses=new qs(this),this.realtime=new js(this),this.conversations=new Qn(this),this.evals=new Yn(this),this.containers=new zn(this),this.videos=new po(this),t===void 0)throw new k("Missing credentials. Please pass an `apiKey`, or set the `OPENAI_API_KEY` environment variable.");const o={apiKey:t,organization:s,project:r,webhookSecret:a,...i,baseURL:e||"https://api.openai.com/v1"};if(!o.dangerouslyAllowBrowser&&pc())throw new k(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new OpenAI({ apiKey, dangerouslyAllowBrowser: true });

https://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety
`);this.baseURL=o.baseURL,this.timeout=o.timeout??ar.DEFAULT_TIMEOUT,this.logger=o.logger??console;const c="warn";this.logLevel=c,this.logLevel=Ur(o.logLevel,"ClientOptions.logLevel",this)??Ur(Fe("OPENAI_LOG"),"process.env['OPENAI_LOG']",this)??c,this.fetchOptions=o.fetchOptions,this.maxRetries=o.maxRetries??2,this.fetch=o.fetch??Sc(),v(this,gs,kc),this._options=o,this.apiKey=typeof t=="string"?t:"Missing Key",this.organization=s,this.project=r,this.webhookSecret=a}withOptions(e){return new this.constructor({...this._options,baseURL:this.baseURL,maxRetries:this.maxRetries,timeout:this.timeout,logger:this.logger,logLevel:this.logLevel,fetch:this.fetch,fetchOptions:this.fetchOptions,apiKey:this.apiKey,organization:this.organization,project:this.project,webhookSecret:this.webhookSecret,...e})}defaultQuery(){return this._options.defaultQuery}validateHeaders({values:e,nulls:t}){}async authHeaders(e){return w([{Authorization:`Bearer ${this.apiKey}`}])}stringifyQuery(e){return Ec(e,{arrayFormat:"brackets"})}getUserAgent(){return`${this.constructor.name}/JS ${We}`}defaultIdempotencyKey(){return`stainless-node-retry-${Ua()}`}makeStatusError(e,t,s,r){return K.generate(e,t,s,r)}async _callApiKey(){const e=this._options.apiKey;if(typeof e!="function")return!1;let t;try{t=await e()}catch(s){throw s instanceof k?s:new k(`Failed to get token from 'apiKey' function: ${s.message}`,{cause:s})}if(typeof t!="string"||!t)throw new k(`Expected 'apiKey' function argument to return a string but it returned ${t}`);return this.apiKey=t,!0}buildURL(e,t,s){const r=!l(this,In,"m",wo).call(this)&&s||this.baseURL,a=hc(e)?new URL(e):new URL(r+(r.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),i=this.defaultQuery();return dc(i)||(t={...i,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(a.search=this.stringifyQuery(t)),a.toString()}async prepareOptions(e){await this._callApiKey()}async prepareRequest(e,{url:t,options:s}){}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,s){return this.request(Promise.resolve(s).then(r=>({method:e,path:t,...r})))}request(e,t=null){return new Ts(this,this.makeRequest(e,t,void 0))}async makeRequest(e,t,s){var L,$;const r=await e,a=r.maxRetries??this.maxRetries;t==null&&(t=a),await this.prepareOptions(r);const{req:i,url:o,timeout:c}=await this.buildRequest(r,{retryCount:a-t});await this.prepareRequest(i,{url:o,options:r});const h="log_"+(Math.random()*(1<<24)|0).toString(16).padStart(6,"0"),m=s===void 0?"":`, retryOf: ${s}`,f=Date.now();if(H(this).debug(`[${h}] sending request`,Ee({retryOfRequestLogID:s,method:r.method,url:o,options:r,headers:i.headers})),(L=r.signal)!=null&&L.aborted)throw new oe;const p=new AbortController,d=await this.fetchWithTimeout(o,i,c,p).catch(yn),_=Date.now();if(d instanceof globalThis.Error){const R=`retrying, ${t} attempts remaining`;if(($=r.signal)!=null&&$.aborted)throw new oe;const S=_n(d)||/timed? ?out/i.test(String(d)+("cause"in d?String(d.cause):""));if(t)return H(this).info(`[${h}] connection ${S?"timed out":"failed"} - ${R}`),H(this).debug(`[${h}] connection ${S?"timed out":"failed"} (${R})`,Ee({retryOfRequestLogID:s,url:o,durationMs:_-f,message:d.message})),this.retryRequest(r,t,s??h);throw H(this).info(`[${h}] connection ${S?"timed out":"failed"} - error; no more retries left`),H(this).debug(`[${h}] connection ${S?"timed out":"failed"} (error; no more retries left)`,Ee({retryOfRequestLogID:s,url:o,durationMs:_-f,message:d.message})),S?new Ln:new Cs({cause:d})}const b=[...d.headers.entries()].filter(([R])=>R==="x-request-id").map(([R,S])=>", "+R+": "+JSON.stringify(S)).join(""),A=`[${h}${m}${b}] ${i.method} ${o} ${d.ok?"succeeded":"failed"} with status ${d.status} in ${_-f}ms`;if(!d.ok){const R=await this.shouldRetry(d);if(t&&R){const C=`retrying, ${t} attempts remaining`;return await xc(d.body),H(this).info(`${A} - ${C}`),H(this).debug(`[${h}] response error (${C})`,Ee({retryOfRequestLogID:s,url:d.url,status:d.status,headers:d.headers,durationMs:_-f})),this.retryRequest(r,t,s??h,d.headers)}const S=R?"error; no more retries left":"error; not retryable";H(this).info(`${A} - ${S}`);const N=await d.text().catch(C=>yn(C).message),O=gc(N),I=O?void 0:N;throw H(this).debug(`[${h}] response error (${S})`,Ee({retryOfRequestLogID:s,url:d.url,status:d.status,headers:d.headers,message:I,durationMs:Date.now()-f})),this.makeStatusError(d.status,O,I,d.headers)}return H(this).info(A),H(this).debug(`[${h}] response start`,Ee({retryOfRequestLogID:s,url:d.url,status:d.status,headers:d.headers,durationMs:_-f})),{response:d,options:r,controller:p,requestLogID:h,retryOfRequestLogID:s,startTime:f}}getAPIList(e,t,s){return this.requestAPIList(t,{method:"get",path:e,...s})}requestAPIList(e,t){const s=this.makeRequest(t,null,void 0);return new Fc(this,s,e)}async fetchWithTimeout(e,t,s,r){const{signal:a,method:i,...o}=t||{};a&&a.addEventListener("abort",()=>r.abort());const c=setTimeout(()=>r.abort(),s),h=globalThis.ReadableStream&&o.body instanceof globalThis.ReadableStream||typeof o.body=="object"&&o.body!==null&&Symbol.asyncIterator in o.body,m={signal:r.signal,...h?{duplex:"half"}:{},method:"GET",...o};i&&(m.method=i.toUpperCase());try{return await this.fetch.call(void 0,e,m)}finally{clearTimeout(c)}}async shouldRetry(e){const t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,s,r){let a;const i=r==null?void 0:r.get("retry-after-ms");if(i){const c=parseFloat(i);Number.isNaN(c)||(a=c)}const o=r==null?void 0:r.get("retry-after");if(o&&!a){const c=parseFloat(o);Number.isNaN(c)?a=Date.parse(o)-Date.now():a=c*1e3}if(!(a&&0<=a&&a<60*1e3)){const c=e.maxRetries??this.maxRetries;a=this.calculateDefaultRetryTimeoutMillis(t,c)}return await Ot(a),this.makeRequest(e,t-1,s)}calculateDefaultRetryTimeoutMillis(e,t){const a=t-e,i=Math.min(.5*Math.pow(2,a),8),o=1-Math.random()*.25;return i*o*1e3}async buildRequest(e,{retryCount:t=0}={}){const s={...e},{method:r,path:a,query:i,defaultBaseURL:o}=s,c=this.buildURL(a,i,o);"timeout"in s&&mc("timeout",s.timeout),s.timeout=s.timeout??this.timeout;const{bodyHeaders:h,body:m}=this.buildBody({options:s}),f=await this.buildHeaders({options:e,method:r,bodyHeaders:h,retryCount:t});return{req:{method:r,headers:f,...s.signal&&{signal:s.signal},...globalThis.ReadableStream&&m instanceof globalThis.ReadableStream&&{duplex:"half"},...m&&{body:m},...this.fetchOptions??{},...s.fetchOptions??{}},url:c,timeout:s.timeout}}async buildHeaders({options:e,method:t,bodyHeaders:s,retryCount:r}){let a={};this.idempotencyHeader&&t!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),a[this.idempotencyHeader]=e.idempotencyKey);const i=w([a,{Accept:"application/json","User-Agent":this.getUserAgent(),"X-Stainless-Retry-Count":String(r),...e.timeout?{"X-Stainless-Timeout":String(Math.trunc(e.timeout/1e3))}:{},...bc(),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project},await this.authHeaders(e),this._options.defaultHeaders,s,e.headers]);return this.validateHeaders(i),i.values}buildBody({options:{body:e,headers:t}}){if(!e)return{bodyHeaders:void 0,body:void 0};const s=w([t]);return ArrayBuffer.isView(e)||e instanceof ArrayBuffer||e instanceof DataView||typeof e=="string"&&s.values.has("content-type")||globalThis.Blob&&e instanceof globalThis.Blob||e instanceof FormData||e instanceof URLSearchParams||globalThis.ReadableStream&&e instanceof globalThis.ReadableStream?{bodyHeaders:void 0,body:e}:typeof e=="object"&&(Symbol.asyncIterator in e||Symbol.iterator in e&&"next"in e&&typeof e.next=="function")?{bodyHeaders:void 0,body:ei(e)}:l(this,gs,"f").call(this,{body:e,headers:s})}}ar=E,gs=new WeakMap,In=new WeakSet,wo=function(){return this.baseURL!=="https://api.openai.com/v1"};E.OpenAI=ar;E.DEFAULT_TIMEOUT=6e5;E.OpenAIError=k;E.APIError=K;E.APIConnectionError=Cs;E.APIConnectionTimeoutError=Ln;E.APIUserAbortError=oe;E.NotFoundError=Ja;E.ConflictError=Xa;E.RateLimitError=Va;E.BadRequestError=Wa;E.AuthenticationError=Da;E.InternalServerError=za;E.PermissionDeniedError=Ha;E.UnprocessableEntityError=Ka;E.InvalidWebhookSignatureError=gt;E.toFile=Dc;E.Completions=Ki;E.Chat=Xn;E.Embeddings=Qi;E.Files=Yi;E.Images=ro;E.Audio=Nt;E.Moderations=io;E.Models=ao;E.FineTuning=ze;E.Graders=sr;E.VectorStores=Us;E.Webhooks=yo;E.Beta=Ve;E.Batches=ji;E.Uploads=rr;E.Responses=qs;E.Realtime=js;E.Conversations=Qn;E.Evals=Yn;E.Containers=zn;E.Videos=po;let $e=null,Ps=null;function Gl(n){$e=new Ct({apiKey:n,dangerouslyAllowBrowser:!0})}function Yl(n){Ps=new E({apiKey:n,dangerouslyAllowBrowser:!0})}function Zl(){return $e!==null}function eu(){return Ps!==null}const bo={twitter:{maxLength:280,style:"concise, punchy, uses 1-2 relevant emojis, includes a hook"},instagram:{maxLength:2200,style:"engaging, storytelling, uses emojis, includes call-to-action, hashtag-friendly"},linkedin:{maxLength:3e3,style:"professional, thought-leadership, insightful, uses line breaks for readability"},tiktok:{maxLength:300,style:"trendy, casual, uses gen-z language, hook in first line, emoji-heavy"}},So={professional:"authoritative, data-driven, industry expert, credible",casual:"friendly, conversational, relatable, approachable",witty:"clever, humorous, uses wordplay, memorable one-liners",inspirational:"motivating, uplifting, visionary, empowering"};async function tu(n){if(!$e)throw new Error("Anthropic API key not configured. Please add your API key in Settings.");const{topic:e,platform:t,tone:s,niche:r,targetAudience:a,includeHashtags:i=!0,additionalContext:o}=n,c=bo[t],h=So[s],m=`You are an expert social media content creator specializing in viral, high-engagement content.

Your expertise:
- Creating platform-optimized content that drives engagement
- Understanding audience psychology and what makes content shareable
- Crafting hooks that stop the scroll
- Writing compelling calls-to-action

Output format: Respond with valid JSON only, no markdown, no code blocks.`,f=`Create a ${t} post about: "${e}"

Requirements:
- Tone: ${h}
- Style: ${c.style}
- Maximum length: ${c.maxLength} characters for the main caption
${r?`- Niche/Industry: ${r}`:""}
${a?`- Target audience: ${a}`:""}
${o?`- Additional context: ${o}`:""}

Respond with this exact JSON structure:
{
  "caption": "The main post content (under ${c.maxLength} chars)",
  "hashtags": ["relevant", "hashtags", "without", "hash", "symbol"],
  "hook": "The attention-grabbing first line",
  "callToAction": "What you want the audience to do"
}

${i?"Include 5-8 relevant hashtags.":"Do not include hashtags."}
Make the content authentic, not generic. Avoid clichÃ©s.`,d=(await $e.messages.create({model:"claude-sonnet-4-20250514",max_tokens:1024,messages:[{role:"user",content:f}],system:m})).content.find(_=>_.type==="text");if(!d||d.type!=="text")throw new Error("No text content in response");try{const _=JSON.parse(d.text);return{caption:_.caption||"",hashtags:Array.isArray(_.hashtags)?_.hashtags:[],hook:_.hook||"",callToAction:_.callToAction||""}}catch{return{caption:d.text.slice(0,c.maxLength),hashtags:[],hook:"",callToAction:""}}}async function su(n,e=3){if(!$e)throw new Error("Anthropic API key not configured. Please add your API key in Settings.");const{topic:t,platform:s,tone:r}=n,a=bo[s],i=So[r],o=`You are an expert social media content creator. Generate multiple unique variations of content, each with a different angle or approach.

Output format: Respond with valid JSON only, no markdown, no code blocks.`,c=`Create ${e} different ${s} posts about: "${t}"

Requirements for each:
- Tone: ${i}
- Style: ${a.style}
- Maximum length: ${a.maxLength} characters
- Each variation should have a unique angle/approach

Respond with this exact JSON structure:
{
  "variations": [
    {
      "caption": "Post content",
      "hashtags": ["relevant", "hashtags"],
      "angle": "Brief description of this variation's unique angle"
    }
  ]
}

Make each variation distinctly different while staying on topic.`,m=(await $e.messages.create({model:"claude-sonnet-4-20250514",max_tokens:2048,messages:[{role:"user",content:c}],system:o})).content.find(f=>f.type==="text");if(!m||m.type!=="text")throw new Error("No text content in response");try{return JSON.parse(m.text).variations||[]}catch{return[]}}async function nu(n){var c,h;if(!Ps)throw new Error("OpenAI API key not configured. Please add your API key in Settings.");const{prompt:e,style:t="vivid",size:s="1024x1024",quality:r="standard"}=n,a=`Create a modern, professional social media image: ${e}.
Style: Clean, high-quality, suitable for social media marketing.
Do not include any text or words in the image.`,o=(h=(c=(await Ps.images.generate({model:"dall-e-3",prompt:a,n:1,size:s,style:t,quality:r})).data)==null?void 0:c[0])==null?void 0:h.url;if(!o)throw new Error("No image generated");return o}async function ru(n,e,t){if(!$e)throw new Error("Anthropic API key not configured.");const r=(await $e.messages.create({model:"claude-sonnet-4-20250514",max_tokens:512,messages:[{role:"user",content:`Analyze how relevant this trend is to the given niche and topics.

Trend: "${n}"
Niche: "${e}"
Topics of interest: ${t.join(", ")}

Respond with this exact JSON structure:
{
  "relevanceScore": 85,
  "reasoning": "Brief explanation of why this score",
  "suggestedAngles": ["angle 1", "angle 2", "angle 3"],
  "targetAudiences": ["audience 1", "audience 2"],
  "bestPlatforms": ["twitter", "linkedin"]
}

relevanceScore should be 0-100. Only include platforms from: twitter, instagram, linkedin, tiktok`}],system:"You are a social media trend analyst. Respond with valid JSON only."})).content.find(a=>a.type==="text");if(!r||r.type!=="text")throw new Error("No text content in response");try{return JSON.parse(r.text)}catch{return{relevanceScore:50,reasoning:"Unable to analyze",suggestedAngles:[],targetAudiences:[],bestPlatforms:["twitter"]}}}export{Ct as A,ru as a,Zl as b,Yl as c,nu as d,su as e,eu as f,tu as g,Gl as i};
