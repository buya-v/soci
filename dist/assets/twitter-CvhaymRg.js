const o="soci_twitter_auth";function w(){const e=a();return e?e.auth_type==="oauth1"?!!(e.oauth1_access_token&&e.oauth1_access_secret):!!(e.access_token&&e.expires_at&&e.expires_at>Date.now()):!1}function a(){try{const e=localStorage.getItem(o);return e?JSON.parse(e):null}catch{return null}}function c(e){localStorage.setItem(o,JSON.stringify(e))}function u(){localStorage.removeItem(o)}function _(e,t,r){c({oauth1_access_token:e,oauth1_access_secret:t,username:r,auth_type:"oauth1"})}function p(){const e=new URLSearchParams(window.location.search),t=e.get("twitter_auth"),r=e.get("data"),s=e.get("error");if((t||s)&&window.history.replaceState({},"",window.location.pathname),s)return{success:!1,error:decodeURIComponent(s)};if(t==="success"&&r)try{const n=JSON.parse(atob(r)),i={access_token:n.access_token,refresh_token:n.refresh_token,expires_at:Date.now()+n.expires_in*1e3,username:n.username,user_id:n.user_id,auth_type:"oauth2"};return c(i),{success:!0,username:i.username}}catch{return{success:!1,error:"Failed to parse authentication data"}}return{success:!1}}async function h(e,t){try{const r=await fetch("/api/twitter/tweet-oauth1",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e,accessToken:t.oauth1_access_token,accessSecret:t.oauth1_access_secret})}),s=await r.json();return r.ok?{success:!0,tweet:s.tweet}:{success:!1,error:s.error||"Failed to post tweet"}}catch{return{success:!1,error:"Network error. Please try again."}}}async function f(){const e=a();if(!e||e.auth_type!=="oauth2")return null;if(e.expires_at&&e.expires_at-Date.now()<5*60*1e3)try{const t=await fetch("/api/twitter/refresh",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:e.refresh_token})});if(!t.ok)return u(),null;const r=await t.json(),s={...e,access_token:r.access_token,refresh_token:r.refresh_token||e.refresh_token,expires_at:Date.now()+r.expires_in*1e3};return c(s),s.access_token||null}catch{return e.access_token||null}return e.access_token||null}async function l(e){const t=await f();if(!t)return{success:!1,error:"Not connected to Twitter. Please connect your account."};try{const r=await fetch("/api/twitter/tweet",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({text:e})}),s=await r.json();return r.ok?{success:!0,tweet:s.tweet}:r.status===401?(u(),{success:!1,error:"Session expired. Please reconnect your Twitter account."}):{success:!1,error:s.error||"Failed to post tweet"}}catch{return{success:!1,error:"Network error. Please try again."}}}async function d(e){const t=a();return t?t.auth_type==="oauth1"?h(e,t):l(e):{success:!1,error:"Not connected to Twitter. Please connect your account."}}function y(){u()}function k(){const e=a();return(e==null?void 0:e.username)||null}function T(){const e=a();return(e==null?void 0:e.auth_type)||null}export{T as a,y as d,k as g,p as h,w as i,d as p,_ as s};
